<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QNA & Peter Â· Italy Trip</title>

  <style>
    :root{
      /* Italy vibe */
      --it-green:#1f7a4c;
      --it-red:#c93a2f;
      --it-cream:#fbfaf7;

      /* Base layers */
      --page:#f3f6ff;
      --page-2:#eef2f8;

      --card:#ffffff;
      --card-2:#fbfdff;

      --text:#0f172a;
      --muted:#64748b;

      --border:rgba(15,23,42,.10);
      --border-strong:rgba(15,23,42,.16);

      --shadow:0 16px 40px rgba(15,23,42,.10);
      --shadow-soft:0 10px 24px rgba(15,23,42,.08);

      --radius:20px;
      --brand:linear-gradient(135deg, #1f7a4c, #2aa56f);
      --brand-soft:linear-gradient(135deg, rgba(31,122,76,.14), rgba(42,165,111,.08));
      --danger:var(--it-red);

      /* colorful blocks */
      --tint-flight: linear-gradient(135deg, rgba(31,122,76,.14), rgba(255,255,255,0));
      --tint-lodging: linear-gradient(135deg, rgba(59,130,246,.14), rgba(255,255,255,0));
      --tint-transport: linear-gradient(135deg, rgba(249,115,22,.14), rgba(255,255,255,0));
      --tint-notes: linear-gradient(135deg, rgba(99,102,241,.12), rgba(255,255,255,0));
      --tint-featured: linear-gradient(135deg, rgba(245,158,11,.18), rgba(255,255,255,0));
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",
                   "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
      background: radial-gradient(900px 600px at 10% -10%, #ffffff 0%, var(--page) 55%, var(--page-2) 100%);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar{
      max-width:1040px; margin:0 auto;
      padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      font-weight:900; letter-spacing:.2px;
      line-height:1.1;
    }
    .brand .sub{ font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.1px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(31,122,76,.10);
      color: var(--it-green);
      border:1px solid rgba(31,122,76,.18);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .pill.danger{
      background: rgba(201,58,47,.10);
      border-color: rgba(201,58,47,.20);
      color: var(--it-red);
    }

    .container{ max-width:1040px; margin:16px auto 96px; padding:0 16px; }
    .grid{ display:grid; gap:14px; }
    @media(min-width:920px){ .grid-2{ grid-template-columns:1.25fr .75fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }

    .title{ margin:0; font-size:26px; font-weight:900; letter-spacing:-.2px; }
    .muted{ color:var(--muted); font-size:14px; line-height:1.5; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .tiny{ font-size:12px; color:var(--muted); }

    /* Main buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:42px; padding:0 14px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:pointer;
      font-size:14px;
      font-weight:900;
      color:#fff;
      background: var(--brand);
      box-shadow: 0 10px 20px rgba(31,122,76,.18);
      transition: transform .08s ease;
      user-select:none;
      line-height:1;
      -webkit-appearance:none;
      appearance:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      color:var(--text);
      background:#fff;
      border:1px solid var(--border);
      box-shadow:none;
    }

    input, select, textarea{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      outline:none;
      width:100%;
    }
    textarea{ min-height:110px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(31,122,76,.45);
      box-shadow:0 0 0 4px rgba(31,122,76,.10);
    }

    /* list item */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:18px;
      background: linear-gradient(180deg, #fff, var(--card-2));
      box-shadow: var(--shadow-soft);
    }
    .item h3{ margin:0; font-size:15px; font-weight:900; }
    .item p{ margin:5px 0 0; font-size:13px; color:var(--muted); line-height:1.45; }

    .star{ cursor:pointer; user-select:none; font-size:20px; line-height:1; }
    .star.on{ color:#f5a623; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    .badge.gold{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.20);
      color:#92400e;
    }

    /* Subcard (colored) */
    .subcard{
      border:1px solid var(--border-strong);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow-soft);
      background: #fff;
      overflow:hidden;
      position:relative;
    }
    .subcard:before{
      content:"";
      position:absolute; inset:0;
      background: var(--brand-soft);
      opacity:.85;
      pointer-events:none;
    }
    .subcard > *{ position:relative; }
    .subcardHead{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:8px;
    }
    .subcardTitle{ font-weight:900; }
    .subcard.tint-flight:before{ background: var(--tint-flight); }
    .subcard.tint-lodging:before{ background: var(--tint-lodging); }
    .subcard.tint-transport:before{ background: var(--tint-transport); }
    .subcard.tint-notes:before{ background: var(--tint-notes); }
    .subcard.tint-featured:before{ background: var(--tint-featured); }

    .subcard textarea{
      min-height:86px;
      background: rgba(255,255,255,.82);
    }

    /* Modules (Photos/Checklist) */
    .modules{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    .module{
      background: linear-gradient(180deg, rgba(255,255,255,.92), var(--card-2));
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-soft);
      border-radius: 18px;
      padding: 14px;
      min-height: 170px;
    }
    .module__head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 10px;
    }
    .module__title{ font-weight: 900; }

    .module__actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-shrink:0;
    }

    /* Minimal small action buttons (iOS-safe) */
    .btnMini, .btnMiniPrimary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:34px;
      padding:0 10px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      line-height:1;
      white-space:nowrap;
      -webkit-appearance:none;
      appearance:none;
      font-family: inherit;
      cursor:pointer;
      user-select:none;
    }
    label.btnMini{ cursor:pointer; }
    .btnMini{
      border:1px solid var(--border);
      background: rgba(255,255,255,.78);
      color: var(--text);
    }
    .btnMiniPrimary{
      border:1px solid transparent;
      background: var(--brand);
      color:#fff;
      box-shadow: 0 10px 20px rgba(31,122,76,.14);
    }

    /* Photos */
    .photoGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap:10px;
    }
    .photoCard{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      position:relative;
    }
    .photoCard img{
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
    }
    .photoCard .x{
      position:absolute; top:8px; right:8px;
      width:32px; height:32px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .photoCard .meta{
      padding:8px 10px;
      font-size:12px;
      color: var(--muted);
    }
    .emptyHint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed var(--border-strong);
      color: var(--muted);
      background: rgba(255,255,255,.65);
    }

    /* Checklist */
    .checkForm{ display:flex; gap:10px; align-items:center; }
    .checkForm input{
      flex:1;
      height:40px;
      border-radius: 14px;
      border: 1px solid var(--border-strong);
      padding: 0 12px;
      background: #fff;
    }
    .checkList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .checkItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
    }
    .checkItem label{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      font-weight:800;
    }
    .checkItem .del{
      width:34px; height:34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }

    /* Bottom tabs */
    .tabbar{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      padding:10px 10px 12px;
    }
    .tabs{
      max-width:1040px; margin:0 auto;
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    }
    .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      padding:10px 8px;
      border-radius:16px;
      border:1px solid transparent;
      color:var(--muted);
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab .ico{ font-size:18px; }
    .tab.active{
      color:var(--it-green);
      background: rgba(31,122,76,.10);
      border-color: rgba(31,122,76,.18);
    }

    /* Responsive */
    @media (max-width: 860px){
      .title{ font-size:24px; }
      .modules{ grid-template-columns: 1fr; }
      .module__actions{ gap:6px; }
      .btnMini, .btnMiniPrimary{ height:32px; padding:0 9px; font-size:12px; border-radius:11px; }
      .checkForm{ flex-wrap:wrap; }
      .checkForm input{ flex:1 1 100%; }
      .checkForm button{ width:100%; height:36px; border-radius:12px; }
    }

    /* Explore */
    .chipbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{ background: rgba(31,122,76,.10); border-color: rgba(31,122,76,.22); color: var(--it-green); }

    /* Itinerary - collapsed day cards */
    .dayCard{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background: #fff;
      box-shadow: 0 10px 25px rgba(15,23,42,.06);
      margin:12px 0;
    }
    .dayHead{
      display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;
      cursor:pointer;
      user-select:none;
    }
    .dayTitle{ margin:0; font-size:16px; font-weight:900; }
    .dayMeta{ color:var(--muted); font-size:13px; margin-top:4px; }

    .progressWrap{ display:flex; align-items:center; gap:10px; }
    .bar{
      width:140px; height:10px; border-radius:999px;
      background: rgba(15,23,42,.08);
      overflow:hidden;
    }
    .bar > div{ height:100%; width:0%; background: var(--brand); border-radius:999px; }

    .chev{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:900;
    }

    .dayBody{ margin-top:10px; display:none; }
    .dayCard.open .dayBody{ display:block; }

    /* period sections */
    .periodBlock{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.94), var(--card-2));
      box-shadow: var(--shadow-soft);
      margin:10px 0;
    }
    .periodHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .periodTitle{ font-weight:900; }
    .periodActions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .select{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-size:13px;
      max-width:240px;
    }

    .slotRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 0;
      border-top:1px dashed rgba(15,23,42,.12);
      align-items:flex-start;
    }
    .slotRow:first-of-type{ border-top:none; }

    .slotMain{ font-size:14px; line-height:1.45; }
    .slotMain .en{ color:var(--muted); font-size:12px; margin-top:3px; }

    .slotTools{
      display:flex; gap:6px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .iconBtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:inline-flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .check{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .check input{ width:16px; height:16px; }
    .done{ opacity:.65; filter: grayscale(.1); }

    .noteHeader{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    .noteTitle{ font-size:16px; font-weight:900; margin:0; }
    .noteHint{ font-size:12px; color:var(--muted); }

    @media(min-width:920px){
      .bar{ width:180px; }
      /* iOS Reminders-like swipe item */
.swipeItem{
  position:relative;
  border:1px solid var(--border);
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow: 0 10px 24px rgba(15,23,42,.05);
  margin:10px 0;
}

/* èƒŒæ™¯å±¤ï¼šå³æ»‘å®Œæˆ / å·¦æ»‘æ›´å¤š */
.swipeBg{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;
  padding:0 14px;
  font-weight:900;
}
.swipeBg .doneBg{
  color:#fff;
  opacity:0;
  transform: translateX(-8px);
  transition: .12s ease;
}
.swipeBg .moreBg{
  display:flex; gap:8px;
  opacity:0;
  transform: translateX(8px);
  transition: .12s ease;
  pointer-events:none;
}
.swipeBg .moreBtn{
  pointer-events:auto;
  border:1px solid rgba(255,255,255,.3);
  background: rgba(255,255,255,.18);
  color:#fff;
  height:34px;
  padding:0 10px;
  border-radius:12px;
  font-weight:900;
  font-size:13px;
}

/* ä¾æ»‘å‹•æ–¹å‘é¡¯ç¤ºèƒŒæ™¯è‰² */
.swipeItem[data-reveal="done"]{ background: linear-gradient(90deg, rgba(31,122,76,.95), rgba(31,122,76,.78)); }
.swipeItem[data-reveal="more"]{ background: linear-gradient(270deg, rgba(201,58,47,.92), rgba(201,58,47,.75)); }
.swipeItem[data-reveal="done"] .doneBg{ opacity:1; transform:none; }
.swipeItem[data-reveal="more"] .moreBg{ opacity:1; transform:none; }

/* å‰æ™¯å±¤ï¼šçœŸçš„å…§å®¹ï¼ˆæ‰‹æŒ‡æ‹–å‹•é€™å±¤ï¼‰ */
.swipeFg{
  position:relative;
  background:#fff;
  padding:12px 12px;
  transform: translateX(0);
  transition: transform .18s ease;
  touch-action: pan-y; /* å…è¨±ä¸Šä¸‹æ»‘ï¼Œä¸è¦è¢«æ°´å¹³å…¨åƒæ‰ */
}
.swipeItem.isDragging .swipeFg{ transition:none; }

/* item å…§å®¹æ’ç‰ˆï¼šå·¦åœˆåœˆ + æ–‡å­— */
.swipeRow{
  display:grid;
  grid-template-columns: 26px 1fr;
  gap:10px;
  align-items:flex-start;
}
.iosCheck{
  width:22px; height:22px;
  border-radius:999px;
  border:2px solid rgba(15,23,42,.22);
  margin-top:2px;
  display:flex; align-items:center; justify-content:center;
  flex:0 0 auto;
}
.iosCheck .tick{
  font-size:14px;
  line-height:1;
  transform: scale(.85);
  opacity:0;
}
.swipeItem[data-done="1"] .iosCheck{
  border-color: rgba(31,122,76,.9);
  background: rgba(31,122,76,.92);
}
.swipeItem[data-done="1"] .iosCheck .tick{
  opacity:1;
  color:#fff;
}
.swipeMain{
  font-size:14px;
  line-height:1.4;
}
.swipeMain .en{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}
.swipeItem[data-done="1"] .swipeMain{
  opacity:.55;
  text-decoration: line-through;
}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div>QNA & Peter ğŸ• <span style="color:var(--it-green)">Italy</span></div>
      <div class="sub">Rome Â· Florence Â· Venice</div>
    </div>
    <div class="pill">âœˆï¸ Flight Mode</div>
  </div>
</header>

<div class="container" id="app"></div>

<div class="tabbar">
  <div class="tabs" id="tabs">
    <a class="tab" href="#home" data-route="home"><div class="ico">ğŸ </div>Home</a>
    <a class="tab" href="#itinerary" data-route="itinerary"><div class="ico">ğŸ“š</div>è¡Œç¨‹</a>
    <a class="tab" href="#explore" data-route="explore"><div class="ico">âœ¨</div>æ¢ç´¢</a>
    <a class="tab" href="#notes" data-route="notes"><div class="ico">ğŸ“</div>ç­†è¨˜</a>
  </div>
</div>

<script>
/* ---------------------------
  Helpers
--------------------------- */
const app = document.getElementById("app");

function uuid(){
  return (crypto?.randomUUID?.())
    || ("id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2));
}
function groupBy(arr, keyFn){
  return arr.reduce((acc, x)=>{
    const k = keyFn(x);
    (acc[k] ||= []).push(x);
    return acc;
  }, {});
}
function labelType(t){
  const map = { spot:"æ™¯é»", food:"é¤å»³", cafe:"å’–å•¡", dessert:"ç”œé»" };
  return map[t] || t;
}
function typeEmoji(t){
  const map = { spot:"ğŸ“", food:"ğŸ½ï¸", cafe:"â˜•", dessert:"ğŸ°" };
  return map[t] || "â€¢";
}
function escapeHTML(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function calcDays(startISO, endISO){
  const s = new Date(startISO + "T00:00:00");
  const e = new Date(endISO + "T00:00:00");
  const ms = e - s;
  return Math.max(1, Math.round(ms / 86400000));
}
function safeJSONParse(raw, fallback){
  try{ return JSON.parse(raw); }catch{ return fallback; }
}

/* ---------------------------
  Data
--------------------------- */
const trip = {
  id:"italy-2026",
  name:"Italy Trip",
  city:"Florence Â· Venice Â· Rome",
  start:"2026-04-04",
  end:"2026-04-12",
  date:"4/4 â€“ 4/12",
  flights:{
    outbound:"4/4 23:45 (TPE T1) â†’ 4/5 07:55 (FCO T3)",
    inbound:"4/12 11:00 (FCO T3) â†’ 4/13 05:40 (TPE T1)"
  }
};

const PLACE_DB = /* === your original PLACE_DB (unchanged) === */ (function(){
  return {
    Italy: {
      Rome: {
        spot: [
          { id:"it-rome-colosseum", name:"ç¾…é¦¬ç«¶æŠ€å ´ Colosseum", tags:["å¿…å»","å¤è¹Ÿ"] },
          { id:"it-rome-forum", name:"å¤ç¾…é¦¬å»£å ´ Roman Forum", tags:["å¤è¹Ÿ","æ­·å²"] },
          { id:"it-rome-pantheon", name:"è¬ç¥æ®¿ Pantheon", tags:["å»ºç¯‰","å¸‚ä¸­å¿ƒ"] },
          { id:"it-rome-trevi", name:"ç‰¹é›·ç¶­å™´æ³‰ Trevi Fountain", tags:["å¿…å»","æ‹ç…§"] },
          { id:"it-rome-spanish", name:"è¥¿ç­ç‰™å°éš Spanish Steps", tags:["é€›è¡—","æ‹ç…§"] },
          { id:"it-rome-navona", name:"ç´æ²ƒç´å»£å ´ Piazza Navona", tags:["å»£å ´","æ•£æ­¥"] },
          { id:"it-rome-vatican", name:"è–å½¼å¾—å»£å ´ St. Peterâ€™s Square", tags:["å®—æ•™","åœ°æ¨™"] },

          { id:"it-rome-aventine-keyhole", name:"é˜¿å‡¡æè«¾é‘°åŒ™å­” Buco della Serratura", tags:["ç¥•å¯†æ™¯é»","æ‹ç…§","å†·é–€ä½†è¶…è®š"] },
          { id:"it-rome-giardino-aranci", name:"æ©˜å­èŠ±åœ’ Giardino degli Aranci", tags:["å¤•é™½","æ™¯è§€","æ•£æ­¥"] },
          { id:"it-rome-galleria-sciarra", name:"å¸Œäºæ‹‰æ‹±å»Š Galleria Sciarra", tags:["å†·é–€","å»ºç¯‰","å…è²»"] },
          { id:"it-rome-quartiere-coppede", name:"ç§‘ä½©ä»£å€ Quartiere CoppedÃ¨", tags:["ç¥•å¯†æ™¯é»","å»ºç¯‰æ§","è¶…å¥½æ‹"] },
          { id:"it-rome-palazzo-spada", name:"æ–¯å¸•é”å®® Palazzo Spadaï¼ˆè¦–è¦ºéŒ¯è¦ºé•·å»Šï¼‰", tags:["å†·é–€","å»ºç¯‰","è¶…æœ‰è¶£"] },
          { id:"it-rome-doria-pamphilj", name:"å¤šåˆ©äºæ½˜è²åˆ©ç¾è¡“é¤¨ Galleria Doria Pamphilj", tags:["å†·é–€","å®¤å…§","æ”¶è—è¶…å¼·"] },
          { id:"it-rome-basilica-s-paolo", name:"åŸå¤–è–ä¿ç¥¿å¤§æ®¿ Basilica of Saint Paul Outside the Walls", tags:["å†·é–€","å®—æ•™","éœ‡æ’¼"] },
          { id:"it-rome-villa-farnesina", name:"æ³•çˆ¾å…§è¥¿ç´åˆ¥å¢… Villa Farnesina", tags:["å†·é–€","å£ç•«","æ–‡è—"] },
          { id:"it-rome-arapacis", name:"å¥§å¤æ–¯éƒ½å’Œå¹³ç¥­å£‡ Ara Pacis", tags:["å»ºç¯‰","å®¤å…§","å¾ˆç¾"] },
        ],
        food: [
          { id:"it-rome-armando", name:"Armando al Pantheon", tags:["å‚³çµ±æ–™ç†","é«˜è©•åƒ¹"] },
          { id:"it-rome-daenzo", name:"Da Enzo al 29", tags:["åœ¨åœ°äººæ°£","æ’éšŠ"] },
          { id:"it-rome-roscioli", name:"Roscioli Salumeria con Cucina", tags:["ç¾©å¤§åˆ©éºµ","ç†Ÿé£Ÿ"] },
          { id:"it-rome-aimarmi", name:"Pizzeria Ai Marmi", tags:["æŠ«è–©","å¹³åƒ¹"] },
          { id:"it-rome-bonci-pizzarium", name:"Pizzarium Bonci", tags:["æŠ«è–©","æ’éšŠ"] },
          { id:"it-rome-trapizzino", name:"Trapizzino", tags:["è¡—é ­ç¾é£Ÿ","æ–¹ä¾¿"] },
          { id:"it-rome-suppli", name:"SupplÃ¬ Roma", tags:["ç‚¸é£¯ç³°","å°åƒ","ç¶“å…¸"] },
          { id:"it-rome-flavio-velavevodetto", name:"Flavio al Velavevodetto", tags:["ç¶“å…¸ç¾…é¦¬èœ","å£ç¢‘","Carbonara"] },
          { id:"it-rome-felice-testaccio", name:"Felice a Testaccio", tags:["cacio e pepe","åœ¨åœ°","è€ç‰Œ"] },
          { id:"it-rome-osteriabonelli", name:"Osteria Bonelli", tags:["åœ¨åœ°","å†·é–€","è¶…å¥½åƒ"] },
          { id:"it-rome-forno-campo", name:"Forno Campo de' Fiori", tags:["éºµåŒ…","æŠ«è–©","å¤–å¸¶"] },
        ],
        cafe: [
          { id:"it-rome-greco", name:"Antico CaffÃ¨ Greco", tags:["ç™¾å¹´å’–å•¡","ç¶“å…¸"] },
          { id:"it-rome-tazza", name:"Tazza dâ€™Oro", tags:["ç²¾å“å’–å•¡","è¬ç¥æ®¿é™„è¿‘"] },
          { id:"it-rome-eustachio", name:"Santâ€™Eustachio Il CaffÃ¨", tags:["äººæ°£å’–å•¡"] },
          { id:"it-rome-faro-luminaries", name:"Faro â€“ Luminaries of Coffee", tags:["ç²¾å“å’–å•¡","å¥½å–","æ–‡é’"] },
          { id:"it-rome-barnum", name:"Barnum Roma", tags:["æ—©åˆé¤","å’–å•¡","è¨­è¨ˆæ„Ÿ"] },
          { id:"it-rome-sciascia", name:"Sciascia CaffÃ¨ 1919", tags:["åœ¨åœ°","è€æ´¾å’–å•¡","æ¿ƒç¸®"] },
        ],
        dessert: [
          { id:"it-rome-giolitti", name:"Giolitti Gelato", tags:["å†°æ·‡æ·‹","è€åº—"] },
          { id:"it-rome-teatro", name:"Gelateria del Teatro", tags:["å†°æ·‡æ·‹","é«˜è©•åƒ¹"] },
          { id:"it-rome-pompi", name:"Pompiï¼ˆææ‹‰ç±³è˜‡ï¼‰", tags:["ææ‹‰ç±³è˜‡","ååº—","å¤–å¸¶"] },
          { id:"it-rome-regoli", name:"Pasticceria Regoli", tags:["ç”œé»","è€åº—","æ—©é¤"] },
          { id:"it-rome-two-sizes", name:"Two Sizesï¼ˆææ‹‰ç±³è˜‡æ¯ï¼‰", tags:["ææ‹‰ç±³è˜‡","æ–¹ä¾¿","å¥½æ‹"] },
        ],
      },

      Florence: {
        spot: [
          { id:"it-flo-duomo", name:"è–æ¯ç™¾èŠ±å¤§æ•™å ‚ Florence Cathedral", tags:["å¿…å»","åœ°æ¨™"] },
          { id:"it-flo-duomo-square", name:"ä¸»æ•™åº§å ‚å»£å ´ Piazza del Duomo", tags:["å¸‚ä¸­å¿ƒ","æ•£æ­¥"] },
          { id:"it-flo-signoria", name:"é ˜ä¸»å»£å ´ Piazza della Signoria", tags:["é›•å¡‘","å»£å ´"] },
          { id:"it-flo-vecchio", name:"è€æ©‹ Ponte Vecchio", tags:["å¤œæ™¯","æ‹ç…§"] },
          { id:"it-flo-michelangelo", name:"ç±³é–‹æœ—åŸºç¾…å»£å ´ Piazzale Michelangelo", tags:["å¤•é™½","å±•æœ›å°"] },
          { id:"it-flo-mercato", name:"ä¸­å¤®å¸‚å ´ Mercato Centrale", tags:["å¹³åƒ¹ç¾é£Ÿ","å¸‚é›†"] },
          { id:"it-flo-sanminiato", name:"è–ç±³å°¼äºæ‰˜æ•™å ‚ San Miniato al Monte", tags:["ç¥•å¯†æ™¯é»","å¤•é™½","æ™¯è§€"] },
          { id:"it-flo-rose-garden", name:"ç«ç‘°èŠ±åœ’ Giardino delle Rose", tags:["å…è²»","æ•£æ­¥","å†·é–€"] },
          { id:"it-flo-bardini", name:"å·´çˆ¾è¿ªå°¼èŠ±åœ’ Giardino Bardini", tags:["ç¥•å¯†æ™¯é»","å±•æœ›","èŠ±åœ’"] },
          { id:"it-flo-santacroce", name:"è–åå­—æ•™å ‚ Basilica di Santa Croce", tags:["ç¶“å…¸","å»ºç¯‰","æ–‡åŒ–"] },
          { id:"it-flo-santamaria-novella", name:"æ–°è–æ¯å¤§æ®¿ Santa Maria Novella", tags:["æ•™å ‚","å¸‚å€","å¥½é€›"] },
          { id:"it-flo-oltrarno", name:"Oltrarno æ‰‹ä½œå€ï¼ˆå··å¼„æ•£æ­¥ï¼‰", tags:["åœ¨åœ°","å†·é–€","ç”Ÿæ´»æ„Ÿ"] },
          { id:"it-flo-piazza-santospirito", name:"è–éˆå»£å ´ Piazza Santo Spirito", tags:["åœ¨åœ°","å¤œæ™š","æ°£æ°›"] },
        ],
        food: [
          { id:"it-flo-zaza", name:"Trattoria ZÃ  ZÃ ", tags:["æ‰˜æ–¯å¡å°¼","äººæ°£"] },
          { id:"it-flo-bucamario", name:"Buca Mario", tags:["ä¸éª¨ç‰›æ’","è€åº—"] },
          { id:"it-flo-4leoni", name:"Trattoria 4 Leoni", tags:["æ¾éœ²","ç¾©å¤§åˆ©éºµ"] },
          { id:"it-flo-santospirito", name:"Osteria Santo Spirito", tags:["åœ¨åœ°é¤é¤¨"] },
          { id:"it-flo-allantico", name:"Allâ€™Antico Vinaioï¼ˆç‰›è‚šåŒ…/ä½›å¡å¤ï¼‰", tags:["å¿…åƒ","æ’éšŠ","å¤–å¸¶"] },
          { id:"it-flo-trattoria-sostanza", name:"Trattoria Sostanza", tags:["ç¶“å…¸","ç‰›æ²¹é›","è€åº—"] },
          { id:"it-flo-da-nerbone", name:"Da Nerboneï¼ˆç‰›è‚šåŒ…ï¼‰", tags:["ä¸­å¤®å¸‚å ´","åœ¨åœ°","ä¾¿å®œ"] },
          { id:"it-flo-io-osteria", name:"Iâ€™ OSTERIA DI GIOVANNI", tags:["æ‰˜æ–¯å¡å°¼","å£ç¢‘","å®¶å¸¸"] },
          { id:"it-flo-il-latto", name:"Il Latini", tags:["T-bone","æ°£æ°›","ç¶“å…¸"] },
        ],
        cafe: [
          { id:"it-flo-gilli", name:"CaffÃ¨ Gilli", tags:["ç™¾å¹´å’–å•¡é¤¨"] },
          { id:"it-flo-ditta", name:"Ditta Artigianale", tags:["ç²¾å“å’–å•¡"] },
          { id:"it-flo-faro", name:"Faro â€“ CaffÃ¨ Specialty", tags:["æ‰‹æ²–"] },
        ],
        dessert: [
          { id:"it-flo-carraia", name:"La Carraia Gelato", tags:["å†°æ·‡æ·‹","é«˜è©•åƒ¹"] },
          { id:"it-flo-percheno", name:"PerchÃ© No! Gelato", tags:["è€å­—è™Ÿ"] },
        ],
      },

      Venice: {
        spot: [
          { id:"it-ven-stmark", name:"è–é¦¬å¯å»£å ´ St Markâ€™s Square", tags:["å¿…å»","åœ°æ¨™"] },
          { id:"it-ven-basilica", name:"è–é¦¬å¯å¤§æ•™å ‚ St Markâ€™s Basilica", tags:["å®—æ•™","å¤–è§€"] },
          { id:"it-ven-doge", name:"ç¸½ç£å®® Dogeâ€™s Palace", tags:["æ­·å²","å¤–è§€"] },
          { id:"it-ven-rialto", name:"é‡Œäºæ‰˜æ©‹ Rialto Bridge", tags:["æ‹ç…§","é‹æ²³"] },
          { id:"it-ven-burano", name:"å¸ƒæ‹‰è«¾å½©è‰²å³¶ Burano", tags:["å½©è‰²å°å³¶","æ‹ç…§"] },
          { id:"it-ven-accademia", name:"å­¸é™¢æ©‹ Accademia Bridge", tags:["å¤•é™½","æ©‹"] },
          { id:"it-ven-bovolo", name:"èºæ—‹æ¨“æ¢¯ Scala Contarini del Bovolo", tags:["ç¥•å¯†æ™¯é»","å»ºç¯‰","ä¿¯ç°"] },
          { id:"it-ven-ghetto", name:"çŒ¶å¤ªå€ Jewish Ghettoï¼ˆCannaregioï¼‰", tags:["å†·é–€","åœ¨åœ°","æ•£æ­¥"] },
          { id:"it-ven-libreria-acqua", name:"æ°´æ›¸åº— Libreria Acqua Alta", tags:["ç¥•å¯†æ™¯é»","æ›¸åº—","å¥½æ‹"] },
          { id:"it-ven-zattere", name:"Zattere æµ·æ¿±é•·å»Šæ•£æ­¥", tags:["æ•£æ­¥","å¤•é™½","åœ¨åœ°"] },
          { id:"it-ven-arsenale", name:"å…µå·¥å»  Arsenaleï¼ˆå¤–éƒ¨æ•£æ­¥ï¼‰", tags:["å†·é–€","æ­·å²","èµ°èµ°"] },
          { id:"it-ven-sanpietro", name:"San Pietro di Castello å‘¨é‚Š", tags:["è¶…å†·é–€","å®‰éœ","åœ¨åœ°"] },
          { id:"it-ven-lido", name:"éº—éƒ½å³¶ Lidoï¼ˆæµ·é‚Š/å–®è»Šï¼‰", tags:["æ”¾é¬†","æµ·é‚Š","åŠæ—¥"] },
        ],
        food: [
          { id:"it-ven-carampane", name:"Antiche Carampane", tags:["æµ·é®®","é«˜è©•åƒ¹"] },
          { id:"it-ven-daivo", name:"Da Ivo", tags:["å‚³çµ±"] },
          { id:"it-ven-madonna", name:"Trattoria Alla Madonna", tags:["è€å­—è™Ÿ"] },
          { id:"it-ven-testiere", name:"Osteria alle Testiere", tags:["éœ€è¨‚ä½","å°è€Œç²¾ç·»"] },
        ],
        cafe: [
          { id:"it-ven-florian", name:"CaffÃ¨ Florian", tags:["ç™¾å¹´","è–é¦¬å¯"] },
          { id:"it-ven-cannaregio", name:"Torrefazione Cannaregio", tags:["åœ¨åœ°"] },
          { id:"it-ven-sullaluna", name:"Sullaluna", tags:["æ›¸åº—å’–å•¡"] },
        ],
        dessert: [
          { id:"it-ven-nico", name:"Gelateria Nico", tags:["å†°æ·‡æ·‹","æ²³å²¸"] },
          { id:"it-ven-natura", name:"Gelato di Natura", tags:["å†°æ·‡æ·‹","æ‰‹å·¥"] },
        ],
      },
    },
  };
})();

function flattenPlaces(db){
  const out = [];
  for(const [country, cities] of Object.entries(db)){
    for(const [area, types] of Object.entries(cities)){
      for(const [type, items] of Object.entries(types)){
        for(const item of items){
          out.push({ ...item, country, area, type });
        }
      }
    }
  }
  return out;
}
const places = flattenPlaces(PLACE_DB);
const placeById = new Map(places.map(p=>[p.id, p]));

/* original default itinerary (template only) */
const itinerary = [
  { day:1, date:"4/5", city:"Florence", move:"Rome â†’ Florence", items:[
    { period:"ä¸Šåˆ", zh:"ç¾…é¦¬æ­é«˜éµå‰å¾€ä½›ç¾…å€«æ–¯", en:"Train from Rome to Florence" },
    { period:"ä¸‹åˆ", zh:"ä½›ç¾…å€«æ–¯ä¸»æ•™åº§å ‚ï¼ˆå¤–è§€ï¼‰", en:"Florence Cathedral (Duomo, exterior)" },
    { period:"ä¸‹åˆ", zh:"ä¸»æ•™åº§å ‚å»£å ´", en:"Piazza del Duomo" },
    { period:"å‚æ™š", zh:"é ˜ä¸»å»£å ´", en:"Piazza della Signoria" },
    { period:"æ™šä¸Š", zh:"è€æ©‹å¤œæ™¯", en:"Ponte Vecchio" },
  ]},
  { day:2, date:"4/6", city:"Florence", items:[
    { period:"ä¸Šåˆ", zh:"Oltrarno å¥§çˆ¾ç‰¹æ‹‰è«¾ç”Ÿæ´»å€æ•£æ­¥", en:"Oltrarno district walk" },
    { period:"ä¸‹åˆ", zh:"æ³¢æ³¢é‡ŒèŠ±åœ’", en:"Boboli Gardens" },
    { period:"å‚æ™š", zh:"ç±³é–‹æœ—åŸºç¾…å»£å ´çœ‹å¤•é™½", en:"Piazzale Michelangelo viewpoint" },
  ]},
  { day:3, date:"4/7", city:"Venice", move:"Florence â†’ Venice", items:[
    { period:"ä¸Šåˆ", zh:"ä½›ç¾…å€«æ–¯æ­é«˜éµå‰å¾€å¨å°¼æ–¯", en:"Train from Florence to Venice" },
    { period:"ä¸‹åˆ", zh:"è–é¦¬å¯å»£å ´", en:"St Mark's Square" },
    { period:"å‚æ™š", zh:"è–é¦¬å¯å¤§æ•™å ‚ï¼ˆå¤–è§€ï¼‰", en:"St Mark's Basilica (exterior)" },
    { period:"æ™šä¸Š", zh:"ç¸½ç£å®®ï¼ˆå¤–è§€ï¼‰", en:"Doge's Palace (exterior)" },
  ]},
  { day:4, date:"4/8", city:"Venice", items:[
    { period:"ä¸Šåˆ", zh:"é‡Œäºæ‰˜æ©‹", en:"Rialto Bridge" },
    { period:"ä¸Šåˆ", zh:"é‡Œäºæ‰˜å¸‚å ´", en:"Rialto Market" },
    { period:"ä¸‹åˆ", zh:"å¸ƒæ‹‰è«¾å½©è‰²å³¶", en:"Burano Island" },
    { period:"å‚æ™š", zh:"å­¸é™¢æ©‹å¤•æ™¯", en:"Accademia Bridge" },
  ]},
  { day:5, date:"4/9", city:"Rome", move:"Venice â†’ Rome", items:[
    { period:"ä¸Šåˆ", zh:"å¨å°¼æ–¯æ­é«˜éµå›ç¾…é¦¬", en:"Train from Venice to Rome" },
    { period:"ä¸‹åˆ", zh:"æ¢µè’‚å²¡åŸæ•£æ­¥", en:"Vatican City walk" },
    { period:"ä¸‹åˆ", zh:"è–å½¼å¾—å»£å ´", en:"St. Peterâ€™s Square" },
    { period:"å‚æ™š", zh:"è–å½¼å¾—å¤§æ•™å ‚ï¼ˆå¤–è§€ï¼‰", en:"St. Peterâ€™s Basilica (exterior)" },
    { period:"æ™šä¸Š", zh:"è–å¤©ä½¿å ¡ï¼ˆå¤–è§€æ•£æ­¥ï¼‰", en:"Castel Santâ€™Angelo (exterior)" },
  ]},
  { day:6, date:"4/10", city:"Rome", items:[
    { period:"ä¸Šåˆ", zh:"ç¾…é¦¬ç«¶æŠ€å ´", en:"Colosseum" },
    { period:"ä¸Šåˆ", zh:"å¤ç¾…é¦¬å»£å ´ï¼ˆå¤–åœæ•£æ­¥ï¼‰", en:"Roman Forum (outside area walk)" },
    { period:"ä¸­åˆ", zh:"çœŸç†ä¹‹å£æ‹ç…§", en:"Bocca della VeritÃ " },
    { period:"å‚æ™š", zh:"å¨å°¼æ–¯å»£å ´", en:"Piazza Venezia" },
  ]},
  { day:7, date:"4/11", city:"Rome", items:[
    { period:"ä¸Šåˆ", zh:"è¬ç¥æ®¿ï¼ˆå¤–è§€ï¼‰", en:"Pantheon (exterior)" },
    { period:"ä¸­åˆ", zh:"ç´æ²ƒç´å»£å ´", en:"Piazza Navona" },
    { period:"ä¸‹åˆ", zh:"ç‰¹é›·ç¶­å™´æ³‰", en:"Trevi Fountain" },
    { period:"å‚æ™š", zh:"è¥¿ç­ç‰™å°éš", en:"Spanish Steps" },
  ]},
];

/* ---------------------------
  Storage
--------------------------- */
const KEY_FAV = "qna_trip_favs_v1";
const KEY_FEATURED = "qna_trip_featured_v1";        // â­ç²¾é¸
const KEY_PLAN = "qna_trip_plan_v1";                // âœ… Day+æ™‚æ®µ è‡ªç”±æ’ç¨‹
const KEY_DONE2 = "qna_trip_done_items_v2";         // âœ… ç”¨ itemId å­˜ï¼Œæ’åºä¸äº‚
const KEY_DAY_OPEN = "qna_trip_day_open_v1";        // âœ… day å±•é–‹ç‹€æ…‹

const KEY_NOTE_GLOBAL = "qna_trip_note_global_v1";
const KEY_NOTE_DAY = "qna_trip_note_day_v1";
const KEY_LODGING = "qna_trip_home_lodging_v1";
const KEY_TRANSPORT = "qna_trip_home_transport_v1";

const CHECK_KEY = "qna_trip_notes_checklist_v1";
const DB_NAME = "qna_trip_photos_db";
const STORE = "photos";

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(raw === null) return fallback;
    const val = JSON.parse(raw);
    return (val ?? fallback);
  }catch{
    return fallback;
  }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* state */
let favs = new Set(loadJSON(KEY_FAV, []));
let featured = new Set(loadJSON(KEY_FEATURED, []));            // placeId set
let dayNotes = loadJSON(KEY_NOTE_DAY, {});
let globalNote = loadJSON(KEY_NOTE_GLOBAL, "");
let lodgingNote = loadJSON(KEY_LODGING, "");
let transportNote = loadJSON(KEY_TRANSPORT, "");
let checks = loadJSON(CHECK_KEY, []);
let doneItems = loadJSON(KEY_DONE2, {});                       // { itemId: true/false }
let openDays = new Set(loadJSON(KEY_DAY_OPEN, []));            // day numbers

/* PLAN: day -> { meta, slots: {period: [items...] } } */
let plan = loadJSON(KEY_PLAN, null);

/* ---------------------------
  Plan init (from default itinerary)
  Each item has stable id: d{day}-p{periodIndex}-i{idx}
--------------------------- */
const PERIOD_ORDER = ["ä¸Šåˆ","ä¸­åˆ","ä¸‹åˆ","å‚æ™š","æ™šä¸Š"];
function ensurePlan(){
  if(plan && typeof plan === "object") return;

  const obj = {};
  for(const d of itinerary){
    const slots = {};
    for(const p of PERIOD_ORDER) slots[p] = [];
    d.items.forEach((it, idx)=>{
      const pid = `d${d.day}-i${idx}`; // stable for migration
      const item = {
        id: pid,
        kind: "text",
        zh: it.zh,
        en: it.en,
        city: d.city,
        period: it.period
      };
      if(!slots[it.period]) slots[it.period] = [];
      slots[it.period].push(item);
    });

    obj[String(d.day)] = {
      day: d.day,
      date: d.date,
      city: d.city,
      move: d.move || "",
      slots
    };
  }
  plan = obj;
  saveJSON(KEY_PLAN, plan);

  // migrate old doneMap (if user had v1 keys day-idx) -> v2 itemId
  const old = loadJSON("qna_trip_done_v1", null);
  if(old && typeof old === "object"){
    const migrated = {...doneItems};
    for(const [k,v] of Object.entries(old)){
      // old key format: "day-idx"
      const m = String(k).match(/^(\d+)-(\d+)$/);
      if(!m) continue;
      const day = Number(m[1]);
      const idx = Number(m[2]);
      const itemId = `d${day}-i${idx}`;
      migrated[itemId] = !!v;
    }
    doneItems = migrated;
    saveJSON(KEY_DONE2, doneItems);
  }
}
ensurePlan();

/* ---------------------------
  Favorites / Featured
--------------------------- */
function toggleFav(id){
  if(favs.has(id)) favs.delete(id); else favs.add(id);
  saveJSON(KEY_FAV, [...favs]);
  // è‹¥å–æ¶ˆæ”¶è—ï¼ŒåŒæ­¥å–æ¶ˆç²¾é¸ï¼ˆé¿å…ç²¾é¸å­¤å…’ï¼‰
  if(!favs.has(id) && featured.has(id)){
    featured.delete(id);
    saveJSON(KEY_FEATURED, [...featured]);
  }
  render();
}
function toggleFeatured(id){
  // ç²¾é¸åªèƒ½å¾æ”¶è—ä¾†
  if(!favs.has(id)){
    favs.add(id);
    saveJSON(KEY_FAV, [...favs]);
  }
  if(featured.has(id)) featured.delete(id); else featured.add(id);
  saveJSON(KEY_FEATURED, [...featured]);
  render();
}

/* ---------------------------
  Plan operations (add / remove / reorder / done)
--------------------------- */
function getDayPlan(day){ return plan?.[String(day)]; }

function setDayOpen(day, open){
  const s = new Set(openDays);
  if(open) s.add(day); else s.delete(day);
  openDays = s;
  saveJSON(KEY_DAY_OPEN, [...openDays]);
  render(); // keep simple
}

function toggleDoneByItemId(itemId){
  doneItems[itemId] = !doneItems[itemId];
  saveJSON(KEY_DONE2, doneItems);
  render();
}

function addFeaturedToSlot(day, period, placeId){
  const d = getDayPlan(day);
  if(!d) return;
  const p = placeById.get(placeId);
  if(!p) return;

  const item = {
    id: uuid(),
    kind: "place",
    placeId: p.id,
    zh: p.name, // keep as displayed name
    en: "",     // not required
    city: d.city,
    period
  };
  if(!d.slots[period]) d.slots[period] = [];
  d.slots[period].push(item);
  saveJSON(KEY_PLAN, plan);
  render();
}

function removeSlotItem(day, period, itemId){
  const d = getDayPlan(day);
  if(!d) return;
  d.slots[period] = (d.slots[period] || []).filter(x=>x.id !== itemId);
  // ä¹Ÿæ¸…æ‰ done ç‹€æ…‹
  if(doneItems[itemId]){ delete doneItems[itemId]; saveJSON(KEY_DONE2, doneItems); }
  saveJSON(KEY_PLAN, plan);
  render();
}

function moveSlotItem(day, period, itemId, dir){
  const d = getDayPlan(day);
  if(!d) return;
  const arr = d.slots[period] || [];
  const idx = arr.findIndex(x=>x.id === itemId);
  if(idx < 0) return;
  const j = idx + dir;
  if(j < 0 || j >= arr.length) return;
  const tmp = arr[idx];
  arr[idx] = arr[j];
  arr[j] = tmp;
  d.slots[period] = arr;
  saveJSON(KEY_PLAN, plan);
  render();
}

/* ---------------------------
  Notes storage
--------------------------- */
function saveDayNote(day){
  const el = document.getElementById(`dayNote-${day}`);
  if(!el) return;
  dayNotes[String(day)] = el.value;
  saveJSON(KEY_NOTE_DAY, dayNotes);
}
function saveGlobalNote(){
  const el = document.getElementById("globalNote");
  if(!el) return;
  globalNote = el.value;
  saveJSON(KEY_NOTE_GLOBAL, globalNote);
}
function saveLodging(){
  const el = document.getElementById("lodgingNote");
  if(!el) return;
  lodgingNote = el.value;
  saveJSON(KEY_LODGING, lodgingNote);
}
function saveTransport(){
  const el = document.getElementById("transportNote");
  if(!el) return;
  transportNote = el.value;
  saveJSON(KEY_TRANSPORT, transportNote);
}

/* ---------------------------
  Checklist
--------------------------- */
function saveChecks(){ saveJSON(CHECK_KEY, checks); }
function renderChecks(){
  const box = document.getElementById("checkList");
  const empty = document.getElementById("checkEmptyHint");
  if(!box) return;

  box.innerHTML = checks.map(it=>`
    <div class="checkItem">
      <label>
        <input type="checkbox" ${it.done ? "checked":""} data-check-toggle="${it.id}">
        <span style="${it.done ? "text-decoration:line-through;opacity:.6":""}">
          ${escapeHTML(it.text)}
        </span>
      </label>
      <button class="del" title="åˆªé™¤" data-check-del="${it.id}">ğŸ—‘ï¸</button>
    </div>
  `).join("");

  if(empty) empty.style.display = checks.length ? "none" : "block";
}

/* ---------------------------
  Photos (IndexedDB)
--------------------------- */
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath: "id" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbPut(record){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(record);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function idbGetAll(){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbDelete(id){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function idbClear(){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function renderPhotos(){
  const grid = document.getElementById("photoGrid");
  const empty = document.getElementById("photoEmptyHint");
  if(!grid) return;

  const items = (await idbGetAll()).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  grid.innerHTML = "";

  for(const it of items){
    const url = URL.createObjectURL(it.blob);
    const el = document.createElement("div");
    el.className = "photoCard";
    el.innerHTML = `
      <button class="x" title="åˆªé™¤" data-photo-del="${it.id}">âœ•</button>
      <img alt="photo" src="${url}">
      <div class="meta">${new Date(it.createdAt).toLocaleString()}</div>
    `;
    el.querySelector("img").addEventListener("load", ()=> URL.revokeObjectURL(url));
    grid.appendChild(el);
  }
  if(empty) empty.style.display = items.length ? "none" : "block";
}

/* ---------------------------
  Router + Tabs
--------------------------- */
function route(){ return (location.hash || "#home").replace("#",""); }
function setActive(routeName){
  document.querySelectorAll("#tabs .tab").forEach(a=>{
    a.classList.toggle("active", a.dataset.route === routeName);
  });
}
window.addEventListener("hashchange", render);

/* ---------------------------
  Views
--------------------------- */
function renderHome(){
  const favArr = [...favs].map(id=>placeById.get(id)).filter(Boolean);
  const featuredArr = [...featured].map(id=>placeById.get(id)).filter(Boolean);
  const days = calcDays(trip.start, trip.end);

  app.innerHTML = `
    <div class="grid grid-2">

      <!-- Left -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="muted">Next Trip</div>
            <h1 class="title">${escapeHTML(trip.name)}</h1>
            <div class="muted">${escapeHTML(trip.city)} Â· ${days} days Â· ${escapeHTML(trip.date)}</div>
          </div>
          <div class="pill">ğŸ‡®ğŸ‡¹ ${escapeHTML(trip.date)}</div>
        </div>

        <div class="hr"></div>

        <div class="subcard tint-flight">
          <div class="subcardHead">
            <div>
              <div class="subcardTitle">âœˆï¸ èˆªç­è³‡è¨Š</div>
              <div class="muted" style="margin-top:6px;">å»ç¨‹ï¼š<strong>${escapeHTML(trip.flights.outbound)}</strong></div>
              <div class="muted" style="margin-top:6px;">å›ç¨‹ï¼š<strong>${escapeHTML(trip.flights.inbound)}</strong></div>
            </div>
            <div class="pill danger">CI</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="subcard tint-lodging">
          <div class="subcardHead">
            <div class="subcardTitle">ğŸ¨ ä½å®¿è³‡è¨Š</div>
            <div class="pill" style="background:rgba(59,130,246,.10);border-color:rgba(59,130,246,.18);color:#1d4ed8;">å¯ç·¨è¼¯</div>
          </div>
          <textarea id="lodgingNote" placeholder="é£¯åº—å/åœ°å€/å…¥ä½é€€æˆ¿/è¨‚æˆ¿ç·¨è™Ÿ/è¯çµ¡æ–¹å¼...">${escapeHTML(lodgingNote)}</textarea>
          <div class="tiny" style="margin-top:6px;">ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</div>
        </div>

        <div style="height:12px"></div>

        <div class="subcard tint-transport">
          <div class="subcardHead">
            <div class="subcardTitle">ğŸš† äº¤é€šè³‡è¨Š</div>
            <div class="pill" style="background:rgba(249,115,22,.10);border-color:rgba(249,115,22,.18);color:#c2410c;">å¯ç·¨è¼¯</div>
          </div>
          <textarea id="transportNote" placeholder="å¸‚å€/åŸéš›/æ©Ÿå ´æ¥é§/ç¥¨åˆ¸/æ³¨æ„äº‹é …...">${escapeHTML(transportNote)}</textarea>
          <div class="tiny" style="margin-top:6px;">ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</div>
        </div>

        <div style="height:10px"></div>
        <div class="tiny">æç¤ºï¼šç…§ç‰‡ï¼†å¾…è¾¦æ¸…å–®åœ¨ã€Œç­†è¨˜ã€åˆ†é ã€‚</div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="muted">Quick Picks</div>
            <h2 class="title" style="font-size:18px;margin-top:6px;">âœ¨ ç²¾é¸</h2>
          </div>
          <div class="pill">Top ${Math.min(featuredArr.length, 6)}</div>
        </div>

        <div class="hr"></div>

        <div class="list">
          ${
            featuredArr.length
              ? featuredArr.slice(0,6).map(p=>`
                <div class="item">
                  <div>
                    <h3>${typeEmoji(p.type)} ${escapeHTML(p.name)}</h3>
                    <p>${escapeHTML(p.area)} Â· ${labelType(p.type)}${p.tags?.length ? ` Â· #${p.tags.map(escapeHTML).join(" #")}` : ""}</p>
                  </div>
                  <div class="right">
                    <span class="badge gold">ç²¾é¸</span>
                    <span class="star on" data-featured-toggle="${p.id}" title="å–æ¶ˆç²¾é¸">â˜…</span>
                  </div>
                </div>
              `).join("")
              : `<div class="muted">å°šæœªè¨­å®šç²¾é¸ï½å» Explore æŠŠå–œæ­¡çš„é»ã€ŒåŠ åˆ°ç²¾é¸ã€âœ¨</div>`
          }
        </div>

        <div style="height:14px"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="muted">Saved</div>
            <h2 class="title" style="font-size:18px;margin-top:6px;">â­ æˆ‘çš„æ”¶è—</h2>
          </div>
          <div class="pill">Top ${Math.min(favArr.length, 6)}</div>
        </div>

        <div class="hr"></div>

        <div class="list">
          ${
            favArr.length
              ? favArr.slice(0,6).map(p=>`
                <div class="item">
                  <div>
                    <h3>${typeEmoji(p.type)} ${escapeHTML(p.name)}</h3>
                    <p>${escapeHTML(p.area)} Â· ${labelType(p.type)}${p.tags?.length ? ` Â· #${p.tags.map(escapeHTML).join(" #")}` : ""}</p>
                  </div>
                  <div class="right">
                    <span class="star on" data-fav-toggle="${p.id}" title="å–æ¶ˆæ”¶è—">â˜…</span>
                  </div>
                </div>
              `).join("")
              : `<div class="muted">ç›®å‰æ²’æœ‰æ”¶è—ï½å» Explore é»æ˜Ÿæ˜Ÿ â­ æ”¶è—å§ã€‚</div>`
          }
        </div>
      </div>

    </div>
  `;

  // auto-save lodging / transport
  document.getElementById("lodgingNote")?.addEventListener("input", saveLodging);
  document.getElementById("transportNote")?.addEventListener("input", saveTransport);
}

function renderItinerary(){
  const days = calcDays(trip.start, trip.end);

  const dayList = Object.values(plan).sort((a,b)=>a.day-b.day);

  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="muted">Itinerary</div>
          <h1 class="title">è¡Œç¨‹</h1>
          <div class="muted">${escapeHTML(trip.city)} Â· ${days} days Â· ${escapeHTML(trip.date)}</div>
          <div class="tiny" style="margin-top:6px;">æç¤ºï¼šæ¯ä¸€å¤©é è¨­æ”¶åˆï¼Œé» Day å¯å±•é–‹ï¼›åŒæ™‚æ®µå¯æ’å¤šå€‹è¡Œç¨‹ï¼ˆ3â€“5+ éƒ½å¯ä»¥ï¼‰ã€‚</div>
        </div>
        <div class="right">
          <button class="btn secondary" onclick="location.hash='#notes'">ğŸ“ å»ç­†è¨˜ï¼ˆç…§ç‰‡/æ¸…å–®ï¼‰</button>
        </div>
      </div>

      <div class="hr"></div>

      ${dayList.map(d=>renderDay(d)).join("")}
    </div>
  `;
}

function calcDayProgress(dayPlan){
  let total = 0, done = 0;
  for(const p of PERIOD_ORDER){
    const arr = dayPlan.slots[p] || [];
    for(const it of arr){
      total += 1;
      if(doneItems[it.id]) done += 1;
    }
  }
  const pct = total ? Math.round((done/total)*100) : 0;
  return {total, done, pct};
}

function renderDay(d){
  const isOpen = openDays.has(d.day);
  const {total, done, pct} = calcDayProgress(d);
  const noteVal = (dayNotes[String(d.day)] || "");

  return `
    <div class="dayCard ${isOpen ? "open" : ""}" id="day-${d.day}">
      <div class="dayHead" data-day-toggle="${d.day}">
        <div>
          <div class="dayTitle">Day ${d.day} (${escapeHTML(d.date)}) Â· ${escapeHTML(d.city)}</div>
          <div class="dayMeta">${d.move ? "ğŸš„ " + escapeHTML(d.move) : ""}</div>
        </div>
        <div class="progressWrap">
          <div class="muted" style="font-weight:900;">${done}/${total}</div>
          <div class="bar"><div style="width:${pct}%"></div></div>
          <div class="pill">${pct}%</div>
          <div class="chev">${isOpen ? "â–¾" : "â–¸"}</div>
        </div>
      </div>

      <div class="dayBody">
        ${PERIOD_ORDER.map(p=>renderPeriod(d.day, p, d.city)).join("")}

        <div style="height:10px"></div>

        <div class="card" style="box-shadow:none;border:1px solid var(--border);">
          <div class="noteHeader">
            <div>
              <div class="noteTitle">ğŸ“ Day ${d.day} Notes</div>
              <div class="noteHint">è¸©é›·/å¿…åƒ/äº¤é€šæé†’/è²·ç¥¨è³‡è¨Šâ€¦ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</div>
            </div>
            <button class="btn secondary" data-save-daynote="${d.day}">ğŸ’¾ å„²å­˜</button>
          </div>
          <div style="height:10px"></div>
          <textarea id="dayNote-${d.day}" placeholder="å¯«ä¸‹ä»Šå¤©çš„ç­†è¨˜â€¦">${escapeHTML(noteVal)}</textarea>
        </div>
      </div>
    </div>
  `;
}

function featuredOptionsForCity(city){
  // ä½ ä¹Ÿå¯ä»¥æ”¹æˆä¸é™åˆ¶åŸå¸‚ï¼šæŠŠ filter æ‹¿æ‰å³å¯
  const arr = [...featured].map(id=>placeById.get(id)).filter(Boolean);
  const filtered = arr.filter(p=>p.area === city);
  return filtered.length ? filtered : arr; // è‹¥åŒåŸæ²’æœ‰ç²¾é¸ï¼Œå°±çµ¦å…¨éƒ¨ç²¾é¸
}

function renderPeriod(day, period, city){
  const d = getDayPlan(day);
  const arr = d?.slots?.[period] || [];
  const options = featuredOptionsForCity(city);

  return `
    <div class="periodBlock">
      <div class="periodHead">
        <div class="periodTitle">${escapeHTML(period)}</div>
        <div class="periodActions">
          <select class="select" data-add-select="${day}|${escapeHTML(period)}">
            <option value="">ï¼‹ å¾ç²¾é¸åŠ å…¥ï¼ˆå¯å¤šé¸å¤šæ¬¡ï¼‰</option>
            ${options.map(p=>`
              <option value="${escapeHTML(p.id)}">âœ¨ ${escapeHTML(p.name)}</option>
            `).join("")}
          </select>
          <span class="badge">å…± ${arr.length}</span>
        </div>
      </div>

      ${arr.length ? arr.map((it, idx)=>renderSlotRow(day, period, it, idx, arr.length)).join("")
                  : `<div class="muted">å°šæœªå®‰æ’ï½å¯ä»¥å¾ç²¾é¸åŠ å…¥ï¼Œæˆ–ä¹‹å¾Œæˆ‘ä¹Ÿèƒ½å¹«ä½ åŠ ã€Œæ‰‹å‹•æ–°å¢ã€æŒ‰éˆ•ã€‚</div>`}
    </div>
  `;
}

function renderSlotRow(day, period, it, idx, len){
  const isDone = !!doneItems[it.id];
  const displayName = it.kind === "place"
    ? (placeById.get(it.placeId)?.name || it.zh || "ï¼ˆå·²åˆªé™¤çš„åœ°é»ï¼‰")
    : (it.zh || "");
  const subtitle = it.kind === "place"
    ? (()=>{
        const p = placeById.get(it.placeId);
        if(!p) return "";
        const tags = (p.tags||[]).slice(0,4).map(t=>"#"+t).join(" ");
        return `${p.area} Â· ${labelType(p.type)}${tags ? " Â· "+tags : ""}`;
      })()
    : (it.en ? it.en : "");

  return `
    <div class="slotRow ${isDone ? "done" : ""}">
      <div class="slotMain">
        <div><strong>${escapeHTML(displayName)}</strong></div>
        ${subtitle ? `<div class="en">${escapeHTML(subtitle)}</div>` : ``}
      </div>

      <div class="slotTools">
        <button class="iconBtn" title="ä¸Šç§»" data-move-up="${day}|${escapeHTML(period)}|${it.id}" ${idx===0 ? "disabled" : ""}>â†‘</button>
        <button class="iconBtn" title="ä¸‹ç§»" data-move-down="${day}|${escapeHTML(period)}|${it.id}" ${idx===len-1 ? "disabled" : ""}>â†“</button>
        <label class="check" title="å‹¾é¸å·²å®Œæˆ">
          <input type="checkbox" ${isDone ? "checked" : ""} data-done-item="${it.id}">
          ${isDone ? "å·²å®Œæˆ" : "æœªå®Œæˆ"}
        </label>
        <button class="iconBtn" title="ç§»é™¤" data-remove-item="${day}|${escapeHTML(period)}|${it.id}">âœ•</button>
      </div>
    </div>
  `;
}

function renderExplore(){
  const type = window.__type || "all";
  const countries = [...new Set(places.map(p=>p.country))].sort();
  const currentCountry = window.__country || (countries[0] || "Italy");
  const cities = [...new Set(places.filter(p=>p.country===currentCountry).map(p=>p.area))].sort();
  const currentCity = window.__city || "all";

  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <div class="muted">Explore</div>
          <h1 class="title">æ¨è–¦æ¸…å–®</h1>
          <div class="muted">ğŸ“æ™¯é» ğŸ½ï¸é¤å»³ â˜•å’–å•¡ ğŸ°ç”œé»ï½œæ”¶è— â­ï½œåŠ åˆ°ç²¾é¸ âœ¨</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="q" placeholder="æœå°‹ï¼šåç¨± / æ¨™ç±¤..." style="flex:1;min-width:220px;" />
        <select id="countrySel" style="max-width:200px;">
          ${countries.map(c=>`
            <option value="${escapeHTML(c)}" ${c===currentCountry?"selected":""}>
              ${c==="Italy"?"ğŸ‡®ğŸ‡¹ Italy":"ğŸŒ "+c}
            </option>
          `).join("")}
        </select>
        <select id="citySel" style="max-width:200px;">
          <option value="all" ${currentCity==="all"?"selected":""}>å…¨éƒ¨åŸå¸‚</option>
          ${cities.map(a=>`
            <option value="${escapeHTML(a)}" ${a===currentCity?"selected":""}>${escapeHTML(a)}</option>
          `).join("")}
        </select>
      </div>

      <div style="height:10px"></div>
      <div class="chipbar" id="chipbar">${renderTypeChips(type)}</div>
      <div class="hr"></div>
      <div id="placeList"></div>
    </div>
  `;

  document.getElementById("q").addEventListener("input", applyFilter);
  document.getElementById("countrySel").addEventListener("change",(e)=>{
    window.__country = e.target.value;
    window.__city = "all";
    renderExplore();
  });
  document.getElementById("citySel").addEventListener("change",(e)=>{
    window.__city = e.target.value;
    applyFilter();
  });

  applyFilter();
}

function renderTypeChips(active){
  const chips = [
    {k:"all", t:"å…¨éƒ¨"},
    {k:"spot", t:"ğŸ“æ™¯é»"},
    {k:"food", t:"ğŸ½ï¸é¤å»³"},
    {k:"cafe", t:"â˜•å’–å•¡"},
    {k:"dessert", t:"ğŸ°ç”œé»"},
  ];
  return chips.map(c=>`
    <span class="chip ${active===c.k ? "active":""}" data-type="${c.k}">${c.t}</span>
  `).join("");
}

function applyFilter(){
  const list = document.getElementById("placeList");
  if(!list) return;

  const q = (document.getElementById("q")?.value || "").toLowerCase().trim();
  const type = window.__type || "all";
  const country = window.__country || "Italy";
  const city = window.__city || "all";

  const filtered = places.filter(p=>{
    if(country && p.country !== country) return false;
    if(city !== "all" && p.area !== city) return false;
    if(type !== "all" && p.type !== type) return false;

    const hay = (p.name+" "+(p.tags||[]).join(" ")).toLowerCase();
    if(q && !hay.includes(q)) return false;
    return true;
  });

  if(!filtered.length){
    list.innerHTML = `<div class="muted">æ²’æœ‰ç¬¦åˆçš„çµæœï¼Œæ›å€‹é—œéµå­—æˆ–ç¯©é¸æ¢ä»¶è©¦è©¦ã€‚</div>`;
    return;
  }

  const byArea = groupBy(filtered, p=>p.area || "Other");
  const areas = Object.keys(byArea).sort();

  list.innerHTML = areas.map(area=>{
    const itemsArea = byArea[area];
    return `
      <div style="margin:8px 0 18px;">
        <div class="pill" style="background:rgba(31,122,76,.08);">${escapeHTML(area)} Â· ${itemsArea.length} items</div>
        <div style="height:10px"></div>

        <div class="list">
          ${itemsArea.map(p=>`
            <div class="item">
              <div>
                <h3>${typeEmoji(p.type)} ${escapeHTML(p.name)}</h3>
                <p>${labelType(p.type)}${p.tags?.length ? ` Â· #${p.tags.map(escapeHTML).join(" #")}` : ""}</p>
              </div>
              <div class="right">
                <span class="star ${favs.has(p.id) ? "on" : ""}"
                  data-fav-toggle="${p.id}"
                  title="${favs.has(p.id) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—"}">${favs.has(p.id) ? "â˜…" : "â˜†"}</span>

                <button class="btnMini ${featured.has(p.id) ? "btnMiniPrimary" : ""}"
                  type="button"
                  data-featured-toggle="${p.id}"
                  title="åŠ åˆ°ç²¾é¸">âœ¨</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  }).join("");
}

function renderNotes(){
  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <div class="muted">Notes</div>
          <h1 class="title">æ—…ç¨‹ç­†è¨˜</h1>
          <div class="muted">å¯«ä¸‹äº¤é€š/èŠ±è²»/è¸©é›·/å¿…åƒ/è³¼ç‰©æ¸…å–®â€¦ï¼ˆè‡ªå‹•ä¿å­˜åˆ°ä½ çš„ç€è¦½å™¨ï¼‰</div>
        </div>
        <button class="btn secondary" data-save-global>ğŸ’¾ å„²å­˜</button>
      </div>

      <div class="hr"></div>

      <div class="subcard tint-notes" style="margin-bottom:14px;">
        <div class="subcardHead">
          <div>
            <div class="subcardTitle">ğŸ§¾ å°ç­†è¨˜</div>
            <div class="muted" style="margin-top:4px;">é€€ç¨…ã€ESIMã€ç¥¨åˆ¸ã€æ³¨æ„äº‹é …ã€è¡Œææ¸…å–®â€¦</div>
          </div>
        </div>
        <textarea id="globalNote" placeholder="å¯«ä¸‹ä½ çš„æ—…ç¨‹ç¸½ç­†è¨˜â€¦">${escapeHTML(globalNote)}</textarea>
        <div class="tiny" style="margin-top:8px;">Tipï¼šæ¯æ—¥ç­†è¨˜åœ¨ã€Œè¡Œç¨‹ã€æ¯ä¸€å¤©åº•ä¸‹ä¹Ÿå¯ä»¥å¯«ã€‚</div>
      </div>

      <div class="modules">
        <section class="module">
          <div class="module__head">
            <div class="module__title">ğŸ“· Photos</div>
            <div class="module__actions">
              <label class="btnMini" for="photoInput">ä¸Šå‚³</label>
              <input type="file" id="photoInput" accept="image/*" multiple hidden />
              <button class="btnMini" id="clearPhotos" type="button">æ¸…ç©º</button>
            </div>
          </div>
          <div class="photoGrid" id="photoGrid"></div>
          <div class="emptyHint" id="photoEmptyHint">å°šæœªä¸Šå‚³ç…§ç‰‡</div>
        </section>

        <section class="module">
          <div class="module__head">
            <div class="module__title">âœ… My Checklist</div>
            <div class="module__actions">
              <button class="btnMini" id="clearCheckAll" type="button">æ¸…ç©º</button>
            </div>
          </div>

          <form class="checkForm" id="checkForm">
            <input id="checkInput" type="text" placeholder="è¼¸å…¥å¾…è¾¦ï¼Œä¾‹å¦‚ï¼šè²·åœ°éµç¥¨ / ä¸‹è¼‰é›¢ç·šåœ°åœ–" />
            <button class="btnMiniPrimary" type="submit">åŠ å…¥</button>
          </form>

          <div class="checkList" id="checkList"></div>
          <div class="emptyHint" id="checkEmptyHint">é‚„æ²’æœ‰å¾…è¾¦æ¸…å–®</div>
        </section>
      </div>
    </div>
  `;

  renderChecks();
  renderPhotos();
}

/* ---------------------------
  Global event delegation (bind once)
--------------------------- */
let __bound = false;
function bindOnce(){
  if(__bound) return;
  __bound = true;

  document.addEventListener("click", async (e)=>{
    const t = e.target;

    // toggle day open/close
    const dayToggle = t?.closest?.("[data-day-toggle]")?.getAttribute?.("data-day-toggle");
    if(dayToggle){
      const day = Number(dayToggle);
      setDayOpen(day, !openDays.has(day));
      return;
    }

    // favorite toggle
    const favId = t?.getAttribute?.("data-fav-toggle");
    if(favId){ toggleFav(favId); return; }

    // featured toggle
    const featId = t?.getAttribute?.("data-featured-toggle");
    if(featId){ toggleFeatured(featId); return; }

    // type chips
    const typeKey = t?.getAttribute?.("data-type");
    if(typeKey){
      window.__type = typeKey;
      const chipbar = document.getElementById("chipbar");
      if(chipbar) chipbar.innerHTML = renderTypeChips(typeKey);
      applyFilter();
      return;
    }

    // save day note
    const dn = t?.getAttribute?.("data-save-daynote");
    if(dn){ saveDayNote(Number(dn)); return; }

    // save global note
    if(t?.hasAttribute?.("data-save-global")){ saveGlobalNote(); return; }

    // checklist delete
    const delId = t?.getAttribute?.("data-check-del");
    if(delId){
      checks = checks.filter(x=>x.id !== delId);
      saveChecks();
      renderChecks();
      return;
    }

    // checklist clear
    if(t?.id === "clearCheckAll"){
      checks = [];
      saveChecks();
      renderChecks();
      return;
    }

    // photos clear
    if(t?.id === "clearPhotos"){
      await idbClear();
      renderPhotos();
      return;
    }

    // photo delete
    const photoDel = t?.getAttribute?.("data-photo-del");
    if(photoDel){
      await idbDelete(photoDel);
      renderPhotos();
      return;
    }

    // reorder up/down
    const up = t?.getAttribute?.("data-move-up");
    if(up){
      const [day, period, itemId] = up.split("|");
      moveSlotItem(Number(day), period, itemId, -1);
      return;
    }
    const down = t?.getAttribute?.("data-move-down");
    if(down){
      const [day, period, itemId] = down.split("|");
      moveSlotItem(Number(day), period, itemId, +1);
      return;
    }

    // remove item
    const rm = t?.getAttribute?.("data-remove-item");
    if(rm){
      const [day, period, itemId] = rm.split("|");
      removeSlotItem(Number(day), period, itemId);
      return;
    }
  });

  document.addEventListener("change", async (e)=>{
    const t = e.target;

    // done checkbox (by item id)
    const doneId = t?.getAttribute?.("data-done-item");
    if(doneId){
      toggleDoneByItemId(doneId);
      return;
    }

    // checklist toggle
    const checkToggle = t?.getAttribute?.("data-check-toggle");
    if(checkToggle){
      checks = checks.map(x=> x.id===checkToggle ? ({...x, done: !!t.checked}) : x);
      saveChecks();
      renderChecks();
      return;
    }

    // photos upload
    if(t?.id === "photoInput"){
      const files = Array.from(t.files || []);
      for(const f of files){
        if(!f.type.startsWith("image/")) continue;
        await idbPut({ id: uuid(), createdAt: Date.now(), name: f.name, blob: f });
      }
      t.value = "";
      renderPhotos();
      return;
    }

    // add featured to slot
    const addSel = t?.getAttribute?.("data-add-select");
    if(addSel){
      const [dayStr, period] = addSel.split("|");
      const placeId = t.value;
      if(placeId){
        addFeaturedToSlot(Number(dayStr), period, placeId);
        t.value = "";
      }
      return;
    }
  });

  document.addEventListener("submit", (e)=>{
    const form = e.target;
    if(form?.id !== "checkForm") return;
    e.preventDefault();
    const input = document.getElementById("checkInput");
    const text = (input?.value || "").trim();
    if(!text) return;
    checks.push({ id: uuid(), text, done:false, createdAt: Date.now() });
    saveChecks();
    renderChecks();
    input.value = "";
  });
}

/* ---------------------------
  Main render
--------------------------- */
function render(){
  const r = route();
  setActive(r);

  if(r === "home") { renderHome(); return; }
  if(r === "itinerary") { renderItinerary(); return; }
  if(r === "explore") { renderExplore(); return; }
  if(r === "notes") { renderNotes(); return; }

  location.hash = "#home";
}

window.addEventListener("DOMContentLoaded", () => {
  bindOnce();
  if(!location.hash) location.hash = "#home";
  render();
});
</script>
</body>
</html>
