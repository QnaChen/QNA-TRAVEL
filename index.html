<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QNA & Peter Â· Italy Trip</title>

  <style>
    :root{
      /* Italy vibe */
      --it-green:#1f7a4c;
      --it-red:#c93a2f;
      --it-cream:#fbfaf7;

      /* Base */
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#121212;
      --muted:#6b7280;
      --border:rgba(17,24,39,.10);

      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;

      --brand:linear-gradient(135deg,var(--it-green),#2a9d6b);
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",
                   "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
      background:var(--bg);
      color:var(--text)
    }

    header{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar{
      max-width:1040px; margin:0 auto;
      padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      font-weight:900; letter-spacing:.2px;
      line-height:1.1;
    }
    .brand .sub{ font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.1px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(31,122,76,.10);
      color: var(--it-green);
      border:1px solid rgba(31,122,76,.18);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    .container{ max-width:1040px; margin:16px auto 96px; padding:0 16px; } /* bottom bar space */
    .grid{ display:grid; gap:14px; }
    @media(min-width:920px){ .grid-2{ grid-template-columns:1.2fr .8fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }

    .title{ margin:0; font-size:22px; font-weight:900; letter-spacing:-.2px; }
    .muted{ color:var(--muted); font-size:14px; line-height:1.5; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:pointer;
      font-size:14px;
      font-weight:800;
      color:#fff;
      background: var(--brand);
      box-shadow: 0 10px 20px rgba(31,122,76,.18);
      transition: transform .08s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      color:var(--text);
      background:#fff;
      border:1px solid var(--border);
      box-shadow:none;
    }

    input, select, textarea{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      outline:none;
      width:100%;
    }
    textarea{ min-height:120px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(31,122,76,.45);
      box-shadow:0 0 0 4px rgba(31,122,76,.10);
    }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:16px;
      background: linear-gradient(180deg, #fff, rgba(251,250,247,.55));
    }
    .item h3{ margin:0; font-size:15px; font-weight:900; }
    .item p{ margin:5px 0 0; font-size:13px; color:var(--muted); line-height:1.45; }

    .star{ cursor:pointer; user-select:none; font-size:20px; line-height:1; }
    .star.on{ color:#f5a623; }

    .chipbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{ background: rgba(31,122,76,.10); border-color: rgba(31,122,76,.22); color: var(--it-green); }

    .dayCard{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background: #fff;
      box-shadow: 0 10px 25px rgba(17,24,39,.06);
      margin:12px 0;
    }
    .dayHead{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .dayTitle{ margin:0; font-size:16px; font-weight:900; }
    .dayMeta{ color:var(--muted); font-size:13px; margin-top:4px; }

    .progressWrap{ display:flex; align-items:center; gap:10px; }
    .bar{
      width:140px; height:10px; border-radius:999px;
      background: rgba(17,24,39,.08);
      overflow:hidden;
    }
    .bar > div{ height:100%; width:0%; background: var(--brand); border-radius:999px; }

    .slot{
      display:grid;
      grid-template-columns:70px 1fr auto;
      gap:10px;
      padding:10px 0;
      border-top:1px dashed rgba(17,24,39,.12);
      align-items:flex-start;
    }
    .slot:first-of-type{ border-top:none; }
    .timeTag{ color:var(--muted); font-size:12px; font-weight:900; letter-spacing:.2px; padding-top:2px; }
    .slotMain{ font-size:14px; line-height:1.45; }
    .slotMain .en{ color:var(--muted); font-size:12px; margin-top:3px; }

    .check{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .check input{ width:16px; height:16px; }
    .done{ opacity:.65; filter: grayscale(.1); }

    .noteHeader{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    .noteTitle{ font-size:16px; font-weight:900; margin:0; }
    .noteHint{ font-size:12px; color:var(--muted); }

    .tabbar{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      padding:10px 10px 12px;
    }
    .tabs{
      max-width:1040px; margin:0 auto;
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    }
    .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      padding:10px 8px;
      border-radius:16px;
      border:1px solid transparent;
      color:var(--muted);
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab .ico{ font-size:18px; }
    .tab.active{
      color:var(--it-green);
      background: rgba(31,122,76,.10);
      border-color: rgba(31,122,76,.18);
    }

    @media(min-width:920px){
      .bar{ width:180px; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div>QNA & Peter âœˆï¸ <span style="color:var(--it-green)">Italy</span> <span style="color:var(--it-red)">ğŸ•</span></div>
      <div class="sub">Rome Â· Florence Â· Venice</div>
    </div>
    <div class="pill"âœˆï¸Trip Mode</div>
  </div>
</header>

<div class="container" id="app"></div>

<div class="tabbar">
  <div class="tabs" id="tabs">
    <a class="tab" href="#home" data-route="home"><div class="ico">ğŸ </div>Home</a>
    <a class="tab" href="#itinerary" data-route="itinerary"><div class="ico">ğŸ“š</div>è¡Œç¨‹</a>
    <a class="tab" href="#explore" data-route="explore"><div class="ico">âœ¨</div>æ¢ç´¢</a>
    <a class="tab" href="#notes" data-route="notes"><div class="ico">ğŸ“</div>ç­†è¨˜</a>
  </div>
</div>

<script>
/* ---------------------------
  Helpers
--------------------------- */
const app = document.getElementById("app");

function groupBy(arr, keyFn){
  return arr.reduce((acc, x)=>{
    const k = keyFn(x);
    (acc[k] ||= []).push(x);
    return acc;
  }, {});
}
function labelType(t){
  const map = { spot:"æ™¯é»", food:"é¤å»³", cafe:"å’–å•¡", dessert:"ç”œé»" };
  return map[t] || t;
}
function typeEmoji(t){
  const map = { spot:"ğŸ“", food:"ğŸ½ï¸", cafe:"â˜•", dessert:"ğŸ°" };
  return map[t] || "â€¢";
}
function escapeHTML(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

/* ---------------------------
  Data
--------------------------- */
const trip = {
  id:"italy-2026",
  name:"Italy Trip",
  city:"Florence â†’ Venice â†’ Rome",
  date:"4/4 â€“ 4/12",
  flights:{
    outbound:"CI75 4/4 23:45 (TPE T1) â†’ 4/5 07:55 (FCO T3)",
    inbound:"CI76 4/12 11:00 (FCO T3) â†’ 4/13 05:40 (TPE T1)"
  }
};

const PLACE_DB = {
  Italy: {
    Rome: {
      spot: [
        { id:"it-rome-colosseum", name:"ç¾…é¦¬ç«¶æŠ€å ´ Colosseum", tags:["å¿…å»","å¤è¹Ÿ"] },
        { id:"it-rome-forum", name:"å¤ç¾…é¦¬å»£å ´ Roman Forum", tags:["å¤è¹Ÿ","æ­·å²"] },
        { id:"it-rome-pantheon", name:"è¬ç¥æ®¿ Pantheonï¼ˆå¤–è§€ï¼‰", tags:["å»ºç¯‰","å¸‚ä¸­å¿ƒ"] },
        { id:"it-rome-trevi", name:"ç‰¹é›·ç¶­å™´æ³‰ Trevi Fountain", tags:["å¿…å»","æ‹ç…§"] },
        { id:"it-rome-spanish", name:"è¥¿ç­ç‰™å°éš Spanish Steps", tags:["é€›è¡—","æ‹ç…§"] },
        { id:"it-rome-navona", name:"ç´æ²ƒç´å»£å ´ Piazza Navona", tags:["å»£å ´","æ•£æ­¥"] },
        { id:"it-rome-vatican", name:"è–å½¼å¾—å»£å ´ St. Peterâ€™s Square", tags:["å®—æ•™","åœ°æ¨™"] },
      ],
      food: [
        { id:"it-rome-armando", name:"Armando al Pantheon", tags:["å‚³çµ±æ–™ç†","é«˜è©•åƒ¹"] },
        { id:"it-rome-daenzo", name:"Da Enzo al 29", tags:["åœ¨åœ°äººæ°£","æ’éšŠ"] },
        { id:"it-rome-roscioli", name:"Roscioli Salumeria con Cucina", tags:["ç¾©å¤§åˆ©éºµ","ç†Ÿé£Ÿ"] },
        { id:"it-rome-aimarmi", name:"Pizzeria Ai Marmi", tags:["æŠ«è–©","å¹³åƒ¹"] },
      ],
      cafe: [
        { id:"it-rome-greco", name:"Antico CaffÃ¨ Greco", tags:["ç™¾å¹´å’–å•¡","ç¶“å…¸"] },
        { id:"it-rome-tazza", name:"Tazza dâ€™Oro", tags:["ç²¾å“å’–å•¡","è¬ç¥æ®¿é™„è¿‘"] },
        { id:"it-rome-eustachio", name:"Santâ€™Eustachio Il CaffÃ¨", tags:["äººæ°£å’–å•¡"] },
      ],
      dessert: [
        { id:"it-rome-giolitti", name:"Giolitti Gelato", tags:["å†°æ·‡æ·‹","è€åº—"] },
        { id:"it-rome-teatro", name:"Gelateria del Teatro", tags:["å†°æ·‡æ·‹","é«˜è©•åƒ¹"] },
      ],
    },

    Florence: {
      spot: [
        { id:"it-flo-duomo", name:"è–æ¯ç™¾èŠ±å¤§æ•™å ‚ Florence Cathedral", tags:["å¿…å»","åœ°æ¨™"] },
        { id:"it-flo-duomo-square", name:"ä¸»æ•™åº§å ‚å»£å ´ Piazza del Duomo", tags:["å¸‚ä¸­å¿ƒ","æ•£æ­¥"] },
        { id:"it-flo-signoria", name:"é ˜ä¸»å»£å ´ Piazza della Signoria", tags:["é›•å¡‘","å»£å ´"] },
        { id:"it-flo-vecchio", name:"è€æ©‹ Ponte Vecchio", tags:["å¤œæ™¯","æ‹ç…§"] },
        { id:"it-flo-michelangelo", name:"ç±³é–‹æœ—åŸºç¾…å»£å ´ Piazzale Michelangelo", tags:["å¤•é™½","å±•æœ›å°"] },
        { id:"it-flo-mercato", name:"ä¸­å¤®å¸‚å ´ Mercato Centrale", tags:["ç¾é£Ÿ","å¸‚é›†"] },
      ],
      food: [
        { id:"it-flo-zaza", name:"Trattoria ZÃ  ZÃ ", tags:["æ‰˜æ–¯å¡å°¼","äººæ°£"] },
        { id:"it-flo-bucamario", name:"Buca Mario", tags:["ä¸éª¨ç‰›æ’","è€åº—"] },
        { id:"it-flo-4leoni", name:"Trattoria 4 Leoni", tags:["æ¾éœ²","ç¾©å¤§åˆ©éºµ"] },
        { id:"it-flo-santospirito", name:"Osteria Santo Spirito", tags:["åœ¨åœ°é¤é¤¨"] },
      ],
      cafe: [
        { id:"it-flo-gilli", name:"CaffÃ¨ Gilli", tags:["ç™¾å¹´å’–å•¡é¤¨"] },
        { id:"it-flo-ditta", name:"Ditta Artigianale", tags:["ç²¾å“å’–å•¡"] },
        { id:"it-flo-faro", name:"Faro â€“ CaffÃ¨ Specialty", tags:["æ‰‹æ²–"] },
      ],
      dessert: [
        { id:"it-flo-carraia", name:"La Carraia Gelato", tags:["å†°æ·‡æ·‹","é«˜è©•åƒ¹"] },
        { id:"it-flo-percheno", name:"PerchÃ© No! Gelato", tags:["è€å­—è™Ÿ"] },
      ],
    },

    Venice: {
      spot: [
        { id:"it-ven-stmark", name:"è–é¦¬å¯å»£å ´ St Markâ€™s Square", tags:["å¿…å»","åœ°æ¨™"] },
        { id:"it-ven-basilica", name:"è–é¦¬å¯å¤§æ•™å ‚ St Markâ€™s Basilica", tags:["å®—æ•™","å¤–è§€"] },
        { id:"it-ven-doge", name:"ç¸½ç£å®® Dogeâ€™s Palace", tags:["æ­·å²","å¤–è§€"] },
        { id:"it-ven-rialto", name:"é‡Œäºæ‰˜æ©‹ Rialto Bridge", tags:["æ‹ç…§","é‹æ²³"] },
        { id:"it-ven-burano", name:"å¸ƒæ‹‰è«¾å½©è‰²å³¶ Burano", tags:["å½©è‰²å°å³¶","æ‹ç…§"] },
        { id:"it-ven-accademia", name:"å­¸é™¢æ©‹ Accademia Bridge", tags:["å¤•é™½","æ©‹"] },
      ],
      food: [
        { id:"it-ven-carampane", name:"Antiche Carampane", tags:["æµ·é®®","é«˜è©•åƒ¹"] },
        { id:"it-ven-daivo", name:"Da Ivo", tags:["å‚³çµ±"] },
        { id:"it-ven-madonna", name:"Trattoria Alla Madonna", tags:["è€å­—è™Ÿ"] },
        { id:"it-ven-testiere", name:"Osteria alle Testiere", tags:["éœ€è¨‚ä½","å°è€Œç²¾ç·»"] },
      ],
      cafe: [
        { id:"it-ven-florian", name:"CaffÃ¨ Florian", tags:["ç™¾å¹´","è–é¦¬å¯"] },
        { id:"it-ven-cannaregio", name:"Torrefazione Cannaregio", tags:["åœ¨åœ°"] },
        { id:"it-ven-sullaluna", name:"Sullaluna", tags:["æ›¸åº—å’–å•¡"] },
      ],
      dessert: [
        { id:"it-ven-nico", name:"Gelateria Nico", tags:["å†°æ·‡æ·‹","æ²³å²¸"] },
        { id:"it-ven-natura", name:"Gelato di Natura", tags:["æ‰‹å·¥"] },
      ],
    },
  },
};

function flattenPlaces(db){
  const out = [];
  for(const [country, cities] of Object.entries(db)){
    for(const [area, types] of Object.entries(cities)){
      for(const [type, items] of Object.entries(types)){
        for(const item of items){
          out.push({ ...item, country, area, type });
        }
      }
    }
  }
  return out;
}
const places = flattenPlaces(PLACE_DB);

const itinerary = [
  { day:1, date:"4/5", city:"Florence", move:"Rome â†’ Florence", items:[
    { period:"ä¸Šåˆ", zh:"ç¾…é¦¬æ­é«˜éµå‰å¾€ä½›ç¾…å€«æ–¯", en:"Train from Rome to Florence" },
    { period:"ä¸‹åˆ", zh:"ä½›ç¾…å€«æ–¯ä¸»æ•™åº§å ‚ï¼ˆå¤–è§€ï¼‰", en:"Florence Cathedral (Duomo, exterior)" },
    { period:"ä¸‹åˆ", zh:"ä¸»æ•™åº§å ‚å»£å ´", en:"Piazza del Duomo" },
    { period:"å‚æ™š", zh:"é ˜ä¸»å»£å ´", en:"Piazza della Signoria" },
    { period:"æ™šä¸Š", zh:"è€æ©‹å¤œæ™¯", en:"Ponte Vecchio" },
  ]},
  { day:2, date:"4/6", city:"Florence", items:[
    { period:"ä¸Šåˆ", zh:"Oltrarno å¥§çˆ¾ç‰¹æ‹‰è«¾ç”Ÿæ´»å€æ•£æ­¥", en:"Oltrarno district walk" },
    { period:"ä¸‹åˆ", zh:"æ³¢æ³¢é‡ŒèŠ±åœ’", en:"Boboli Gardens" },
    { period:"å‚æ™š", zh:"ç±³é–‹æœ—åŸºç¾…å»£å ´çœ‹å¤•é™½", en:"Piazzale Michelangelo viewpoint" },
  ]},
  { day:3, date:"4/7", city:"Venice", move:"Florence â†’ Venice", items:[
    { period:"ä¸Šåˆ", zh:"ä½›ç¾…å€«æ–¯æ­é«˜éµå‰å¾€å¨å°¼æ–¯", en:"Train from Florence to Venice" },
    { period:"ä¸‹åˆ", zh:"è–é¦¬å¯å»£å ´", en:"St Mark's Square" },
    { period:"å‚æ™š", zh:"è–é¦¬å¯å¤§æ•™å ‚ï¼ˆå¤–è§€ï¼‰", en:"St Mark's Basilica (exterior)" },
    { period:"æ™šä¸Š", zh:"ç¸½ç£å®®ï¼ˆå¤–è§€ï¼‰", en:"Doge's Palace (exterior)" },
  ]},
  { day:4, date:"4/8", city:"Venice", items:[
    { period:"ä¸Šåˆ", zh:"é‡Œäºæ‰˜æ©‹", en:"Rialto Bridge" },
    { period:"ä¸Šåˆ", zh:"é‡Œäºæ‰˜å¸‚å ´", en:"Rialto Market" },
    { period:"ä¸‹åˆ", zh:"å¸ƒæ‹‰è«¾å½©è‰²å³¶", en:"Burano Island" },
    { period:"å‚æ™š", zh:"å­¸é™¢æ©‹å¤•æ™¯", en:"Accademia Bridge" },
  ]},
  { day:5, date:"4/9", city:"Rome", move:"Venice â†’ Rome", items:[
    { period:"ä¸Šåˆ", zh:"å¨å°¼æ–¯æ­é«˜éµå›ç¾…é¦¬", en:"Train from Venice to Rome" },
    { period:"ä¸‹åˆ", zh:"æ¢µè’‚å²¡åŸæ•£æ­¥", en:"Vatican City walk" },
    { period:"ä¸‹åˆ", zh:"è–å½¼å¾—å»£å ´", en:"St. Peterâ€™s Square" },
    { period:"å‚æ™š", zh:"è–å½¼å¾—å¤§æ•™å ‚ï¼ˆå¤–è§€ï¼‰", en:"St. Peterâ€™s Basilica (exterior)" },
    { period:"æ™šä¸Š", zh:"è–å¤©ä½¿å ¡ï¼ˆå¤–è§€æ•£æ­¥ï¼‰", en:"Castel Santâ€™Angelo (exterior)" },
  ]},
  { day:6, date:"4/10", city:"Rome", items:[
    { period:"ä¸Šåˆ", zh:"ç¾…é¦¬ç«¶æŠ€å ´", en:"Colosseum" },
    { period:"ä¸Šåˆ", zh:"å¤ç¾…é¦¬å»£å ´ï¼ˆå¤–åœæ•£æ­¥ï¼‰", en:"Roman Forum (outside area walk)" },
    { period:"ä¸­åˆ", zh:"çœŸç†ä¹‹å£æ‹ç…§", en:"Bocca della VeritÃ " },
    { period:"å‚æ™š", zh:"å¨å°¼æ–¯å»£å ´", en:"Piazza Venezia" },
  ]},
  { day:7, date:"4/11", city:"Rome", items:[
    { period:"ä¸Šåˆ", zh:"è¬ç¥æ®¿ï¼ˆå¤–è§€ï¼‰", en:"Pantheon (exterior)" },
    { period:"ä¸­åˆ", zh:"ç´æ²ƒç´å»£å ´", en:"Piazza Navona" },
    { period:"ä¸‹åˆ", zh:"ç‰¹é›·ç¶­å™´æ³‰", en:"Trevi Fountain" },
    { period:"å‚æ™š", zh:"è¥¿ç­ç‰™å°éš", en:"Spanish Steps" },
  ]},
];

/* ---------------------------
  Storage
--------------------------- */
const KEY_FAV = "qna_trip_favs_v1";
const KEY_DONE = "qna_trip_done_v1";
const KEY_NOTE_GLOBAL = "qna_trip_note_global_v1";
const KEY_NOTE_DAY = "qna_trip_note_day_v1";

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(raw === null) return fallback;
    const val = JSON.parse(raw);
    return (val ?? fallback);
  }catch{
    return fallback;
  }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let favs = new Set(loadJSON(KEY_FAV, []));
let doneMap = loadJSON(KEY_DONE, {});
let dayNotes = loadJSON(KEY_NOTE_DAY, {});
let globalNote = loadJSON(KEY_NOTE_GLOBAL, "");

function toggleFav(id){
  if(favs.has(id)) favs.delete(id); else favs.add(id);
  saveJSON(KEY_FAV, [...favs]);
  render();
}
function itemKey(day, idx){ return `${day}-${idx}`; }
function toggleDone(day, idx){
  const k = itemKey(day, idx);
  doneMap[k] = !doneMap[k];
  saveJSON(KEY_DONE, doneMap);
  render();
}
function saveDayNote(day){
  const el = document.getElementById(`dayNote-${day}`);
  if(!el) return;
  dayNotes[String(day)] = el.value;
  saveJSON(KEY_NOTE_DAY, dayNotes);
  render(); // optional: refresh
}
function saveGlobalNote(){
  const el = document.getElementById("globalNote");
  if(!el) return;
  globalNote = el.value;
  saveJSON(KEY_NOTE_GLOBAL, globalNote);
}

/* ---------------------------
  Router + Tabs
--------------------------- */
function route(){ return (location.hash || "#home").replace("#",""); }
function setActive(routeName){
  document.querySelectorAll("#tabs .tab").forEach(a=>{
    a.classList.toggle("active", a.dataset.route === routeName);
  });
}
window.addEventListener("hashchange", render);

/* ---------------------------
  Views
--------------------------- */
function renderHome(){
  const favArr = [...favs].map(id=>places.find(p=>p.id===id)).filter(Boolean);

  app.innerHTML = `
    <div class="grid grid-2">

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Next Trip</div>
            <h1 class="title">${trip.name}</h1>
            <div class="muted">${trip.city} Â· ${trip.days} days Â· ${trip.date}</div>
          </div>
          <div class="pill">ğŸ‡®ğŸ‡¹ ${trip.date}</div>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;border:1px solid var(--border);background:linear-gradient(180deg,var(--it-cream),#fff);">
          <div class="row" style="justify-content:space-between;align-items:flex-start;">
            <div>
              <div style="font-weight:900;margin-bottom:6px;">âœˆï¸ èˆªç­è³‡è¨Š</div>
              <div class="muted" style="margin-bottom:6px;">å»ç¨‹ï¼š<strong>${trip.flights.outbound}</strong></div>
              <div class="muted">å›ç¨‹ï¼š<strong>${trip.flights.inbound}</strong></div>
            </div>
            <div class="pill" style="background:rgba(201,58,47,.10);border-color:rgba(201,58,47,.20);color:var(--it-red);">CI75 / CI76</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <button class="btn" onclick="location.hash='#itinerary'">âœ… çœ‹è¡Œç¨‹ + Checklist</button>
          <button class="btn secondary" onclick="location.hash='#explore'">âœ¨ Explore æ¨è–¦</button>
          <button class="btn secondary" onclick="location.hash='#notes'">ğŸ“ æ—…ç¨‹ç­†è¨˜</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Quick Picks</div>
            <h2 class="title" style="font-size:18px;margin-top:6px;">â­ æˆ‘çš„æ”¶è—</h2>
          </div>
          <div class="pill">Top ${Math.min(favArr.length, 6)}</div>
        </div>

        <div class="hr"></div>

        <div class="list">
          ${
            favArr.length
              ? favArr.slice(0,6).map(p=>`
                <div class="item">
                  <div>
                    <h3>${typeEmoji(p.type)} ${escapeHTML(p.name)}</h3>
                    <p>${escapeHTML(p.area)} Â· ${labelType(p.type)}${p.tags?.length ? ` Â· #${p.tags.map(escapeHTML).join(" #")}` : ""}</p>
                  </div>
                  <div class="right">
                    <span class="star on" onclick="toggleFav('${p.id}')" title="å–æ¶ˆæ”¶è—">â˜…</span>
                  </div>
                </div>
              `).join("")
              : `<div class="muted">ç›®å‰æ²’æœ‰æ”¶è—ï½å» Explore é»æ˜Ÿæ˜Ÿ â­ æ”¶è—å§ã€‚</div>`
          }
        </div>
      </div>

    </div>
  `;
}

function renderItinerary(){
  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="muted">Itinerary</div>
          <h1 class="title">è¡Œç¨‹ + Checklist</h1>
          <div class="muted">${trip.city} Â· ${trip.days} days Â· ${trip.date}</div>
        </div>
        <div class="right">
          <button class="btn secondary" onclick="location.hash='#notes'">ğŸ“ å»å¯«ç­†è¨˜</button>
        </div>
      </div>

      <div class="hr"></div>

      ${itinerary.map(d=>renderDay(d)).join("")}
    </div>
  `;
}

function renderDay(d){
  const total = d.items.length;
  const done = d.items.reduce((acc, _, idx)=> acc + (doneMap[itemKey(d.day, idx)] ? 1 : 0), 0);
  const pct = total ? Math.round((done/total)*100) : 0;
  const noteVal = (dayNotes[String(d.day)] || "");

  return `
    <div class="dayCard" id="day-${d.day}">
      <div class="dayHead">
        <div>
          <div class="dayTitle">Day ${d.day} (${d.date}) Â· ${escapeHTML(d.city)}</div>
          <div class="dayMeta">${d.move ? "ğŸš„ " + escapeHTML(d.move) : ""}</div>
        </div>
        <div class="progressWrap">
          <div class="muted" style="font-weight:900;">${done}/${total}</div>
          <div class="bar"><div style="width:${pct}%"></div></div>
          <div class="pill">${pct}%</div>
        </div>
      </div>

      <div class="hr"></div>

      ${d.items.map((it, idx)=>{
        const isDone = !!doneMap[itemKey(d.day, idx)];
        return `
          <div class="slot ${isDone ? "done" : ""}">
            <div class="timeTag">${escapeHTML(it.period)}</div>
            <div class="slotMain">
              <div><strong>${escapeHTML(it.zh)}</strong></div>
              <div class="en">${escapeHTML(it.en)}</div>
            </div>
            <label class="check" title="å‹¾é¸å·²å®Œæˆ">
              <input type="checkbox" ${isDone ? "checked" : ""} onchange="toggleDone(${d.day}, ${idx})">
              ${isDone ? "å·²å®Œæˆ" : "æœªå®Œæˆ"}
            </label>
          </div>
        `;
      }).join("")}

      <div style="height:10px"></div>

      <div class="card" style="box-shadow:none;border:1px solid var(--border);">
        <div class="noteHeader">
          <div>
            <div class="noteTitle">ğŸ“ Day ${d.day} Notes</div>
            <div class="noteHint">è¸©é›·/å¿…åƒ/äº¤é€šæé†’/è²·ç¥¨è³‡è¨Šâ€¦ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</div>
          </div>
          <button class="btn secondary" onclick="saveDayNote(${d.day})">ğŸ’¾ å„²å­˜</button>
        </div>
        <div style="height:10px"></div>
        <textarea id="dayNote-${d.day}" placeholder="å¯«ä¸‹ä»Šå¤©çš„ç­†è¨˜â€¦">${escapeHTML(noteVal)}</textarea>
      </div>
    </div>
  `;
}

function renderExplore(){
  const type = window.__type || "all";

  const countries = [...new Set(places.map(p=>p.country))].sort();
  const currentCountry = window.__country || (countries[0] || "Italy");

  const cities = [...new Set(places.filter(p=>p.country===currentCountry).map(p=>p.area))].sort();
  const currentCity = window.__city || "all";

  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <div class="muted">Explore</div>
          <h1 class="title">æ¨è–¦æ¸…å–®</h1>
          <div class="muted">ğŸ“æ™¯é» ğŸ½ï¸é¤å»³ â˜•å’–å•¡ ğŸ°ç”œé»ï½œæœå°‹ + æ”¶è— â­</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="q" placeholder="æœå°‹ï¼šåç¨± / æ¨™ç±¤..." style="flex:1;min-width:220px;" />

        <select id="countrySel" style="max-width:200px;">
          ${countries.map(c=>`
            <option value="${escapeHTML(c)}" ${c===currentCountry?"selected":""}>
              ${c==="Italy"?"ğŸ‡®ğŸ‡¹ Italy":"ğŸŒ "+c}
            </option>
          `).join("")}
        </select>

        <select id="citySel" style="max-width:200px;">
          <option value="all" ${currentCity==="all"?"selected":""}>å…¨éƒ¨åŸå¸‚</option>
          ${cities.map(a=>`
            <option value="${escapeHTML(a)}" ${a===currentCity?"selected":""}>${escapeHTML(a)}</option>
          `).join("")}
        </select>
      </div>

      <div style="height:10px"></div>

      <div class="chipbar" id="chipbar">${renderTypeChips(type)}</div>

      <div class="hr"></div>

      <div id="placeList"></div>
    </div>
  `;

  document.getElementById("q").addEventListener("input", applyFilter);

  document.getElementById("countrySel").addEventListener("change",(e)=>{
    window.__country = e.target.value;
    window.__city = "all";
    renderExplore();
  });

  document.getElementById("citySel").addEventListener("change",(e)=>{
    window.__city = e.target.value;
    applyFilter();
  });

  applyFilter();
}

function renderTypeChips(active){
  const chips = [
    {k:"all", t:"å…¨éƒ¨"},
    {k:"spot", t:"ğŸ“æ™¯é»"},
    {k:"food", t:"ğŸ½ï¸é¤å»³"},
    {k:"cafe", t:"â˜•å’–å•¡"},
    {k:"dessert", t:"ğŸ°ç”œé»"},
  ];
  return chips.map(c=>`
    <span class="chip ${active===c.k ? "active":""}" onclick="setType('${c.k}')">${c.t}</span>
  `).join("");
}

function setType(t){
  window.__type = t;
  const chipbar = document.getElementById("chipbar");
  if(chipbar) chipbar.innerHTML = renderTypeChips(t);
  applyFilter();
}

function applyFilter(){
  const list = document.getElementById("placeList");
  if(!list) return;

  const q = (document.getElementById("q")?.value || "").toLowerCase().trim();
  const type = window.__type || "all";
  const country = window.__country || "Italy";
  const city = window.__city || "all";

  const filtered = places.filter(p=>{
    if(country && p.country !== country) return false;
    if(city !== "all" && p.area !== city) return false;
    if(type !== "all" && p.type !== type) return false;

    const hay = (p.name+" "+(p.tags||[]).join(" ")).toLowerCase();
    if(q && !hay.includes(q)) return false;

    return true;
  });

  if(!filtered.length){
    list.innerHTML = `<div class="muted">æ²’æœ‰ç¬¦åˆçš„çµæœï¼Œæ›å€‹é—œéµå­—æˆ–ç¯©é¸æ¢ä»¶è©¦è©¦ã€‚</div>`;
    return;
  }

  // ä¾åŸå¸‚åˆ†çµ„
  const byArea = groupBy(filtered, p=>p.area || "Other");
  const areas = Object.keys(byArea).sort();

  list.innerHTML = areas.map(area=>{
    const itemsArea = byArea[area];

    return `
      <div style="margin:8px 0 18px;">
        <div class="pill" style="background:rgba(31,122,76,.08);">${escapeHTML(area)} Â· ${itemsArea.length} items</div>
        <div style="height:10px"></div>

        <div class="list">
          ${itemsArea.map(p=>`
            <div class="item">
              <div>
                <h3>${typeEmoji(p.type)} ${escapeHTML(p.name)}</h3>
                <p>${labelType(p.type)}${p.tags?.length ? ` Â· #${p.tags.map(escapeHTML).join(" #")}` : ""}</p>
              </div>
              <div class="right">
                <span class="star ${favs.has(p.id) ? "on" : ""}"
                  onclick="toggleFav('${p.id}')"
                  title="${favs.has(p.id) ? "å–æ¶ˆæ”¶è—" : "åŠ å…¥æ”¶è—"}">${favs.has(p.id) ? "â˜…" : "â˜†"}</span>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  }).join("");
}

function renderNotes(){
  app.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <div class="muted">Notes</div>
          <h1 class="title">æ—…ç¨‹ç­†è¨˜</h1>
          <div class="muted">å¯«ä¸‹äº¤é€š/èŠ±è²»/è¸©é›·/å¿…åƒ/è³¼ç‰©æ¸…å–®â€¦ï¼ˆè‡ªå‹•ä¿å­˜åˆ°ä½ çš„ç€è¦½å™¨ï¼‰</div>
        </div>
        <button class="btn secondary" onclick="saveGlobalNote()">ğŸ’¾ å„²å­˜</button>
      </div>

      <div class="hr"></div>

      <div class="card" style="box-shadow:none;border:1px solid var(--border);">
        <div class="noteHeader">
          <div>
            <div class="noteTitle">ğŸ§¾ å…¨åŸŸç­†è¨˜</div>
            <div class="noteHint">ä¾‹å¦‚ï¼šé€€ç¨…ã€SIMå¡ã€ç¥¨åˆ¸ã€æ³¨æ„äº‹é …ã€è¡Œææ¸…å–®â€¦</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <textarea id="globalNote" placeholder="å¯«ä¸‹ä½ çš„æ—…ç¨‹ç¸½ç­†è¨˜â€¦">${escapeHTML(globalNote)}</textarea>
        <div class="muted" style="margin-top:8px;font-size:12px;">
          Tipï¼šæ¯æ—¥ç­†è¨˜åœ¨ã€Œè¡Œç¨‹ã€æ¯ä¸€å¤©åº•ä¸‹ä¹Ÿå¯ä»¥å¯«ã€‚
        </div>
      </div>
    </div>
  `;
}

/* ---------------------------
  Main render (single)
--------------------------- */
function render(){
  const r = route();
  setActive(r);

  if(r === "home") return renderHome();
  if(r === "itinerary") return renderItinerary();
  if(r === "explore") return renderExplore();
  if(r === "notes") return renderNotes();

  location.hash = "#home";
}

window.addEventListener("DOMContentLoaded", () => {
  // default state
  if(!location.hash) location.hash = "#home";
  render();
});
</script>
</body>
</html>
